<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Team Scheduling Tool</title>

  <style>
    /* Theme tokens
       - default: light
       - dark theme: html[data-theme="dark"]
    */

    :root{
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";

      /* Light theme */
      --bg:#f6f8fc;
      --panel:#ffffff;
      --panel2:#ffffff;
      --text:#0f172a;
      --muted:#475569;
      --border:rgba(15,23,42,.14);
      --accent:#0284c7;
      --accent2:#7c3aed;
      --good:#059669;
      --bad:#e11d48;
      --shadow: 0 12px 30px rgba(2,6,23,.10);

      --slotBg: rgba(2,6,23,.03);
      --slotBgHover: rgba(2,132,199,.06);
      --slotSelBg: rgba(5,150,105,.10);
      --slotComBg: rgba(2,132,199,.08);
      --toastBg: rgba(255,255,255,.92);

      --radius: 18px;
      --radius2: 22px;
    }

    html[data-theme="dark"]{
      --bg:#0b0f19;
      --panel:#10182a;
      --panel2:#0f1729;
      --text:#e9eef9;
      --muted:#94a3b8;
      --border:rgba(148,163,184,.22);
      --accent:#7dd3fc;
      --accent2:#c084fc;
      --good:#34d399;
      --bad:#fb7185;
      --shadow: 0 12px 30px rgba(0,0,0,.35);

      --slotBg: rgba(10,14,24,.46);
      --slotBgHover: rgba(125,211,252,.12);
      --slotSelBg: rgba(52,211,153,.10);
      --slotComBg: rgba(125,211,252,.10);
      --toastBg: rgba(15,23,41,.90);
    }

    *{box-sizing:border-box}
    html,body{height:100%}

    body{
      margin:0;
      font-family:var(--sans);
      background:
        radial-gradient(1200px 700px at 20% 10%, color-mix(in srgb, var(--accent) 20%, transparent), transparent 60%),
        radial-gradient(1000px 650px at 85% 15%, color-mix(in srgb, var(--accent2) 18%, transparent), transparent 55%),
        linear-gradient(180deg, color-mix(in srgb, var(--bg) 92%, #ffffff) 0%, var(--bg) 100%);
      color:var(--text);
      line-height:1.35;
    }

    .wrap{max-width:1100px;margin:0 auto;padding:28px 18px 54px;}

    header{
      display:flex;
      gap:18px;
      align-items:flex-start;
      justify-content:space-between;
      margin-bottom:18px;
    }

    h1{
      margin:0;
      font-size: clamp(22px, 4vw, 34px);
      letter-spacing:-.02em;
    }

    .subtitle{color:var(--muted);font-size:14px;margin-top:6px;}

    .badgeRow{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px;}
    .pill{
      border:1px solid var(--border);
      background:color-mix(in srgb, var(--panel) 86%, transparent);
      padding:8px 10px;
      border-radius:999px;
      color:var(--muted);
      font-size:12px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .dot{width:8px;height:8px;border-radius:99px;background:var(--accent);}

    .grid{
      display:grid;
      grid-template-columns: 380px 1fr;
      gap:14px;
    }
    @media (max-width: 980px){ .grid{grid-template-columns:1fr;} }

    .panel{
      background: linear-gradient(180deg, color-mix(in srgb, var(--panel) 92%, transparent), color-mix(in srgb, var(--panel2) 88%, transparent));
      border:1px solid var(--border);
      border-radius:var(--radius2);
      box-shadow:var(--shadow);
      overflow:hidden;
    }

    .panelHead{
      padding:16px 16px 12px;
      border-bottom:1px solid color-mix(in srgb, var(--border) 72%, transparent);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }

    .panelHead h2{margin:0;font-size:16px;letter-spacing:-.01em;}
    .panelHead p{margin:6px 0 0;color:var(--muted);font-size:13px;}
    .panelBody{padding:16px;}

    .field{display:flex;flex-direction:column;gap:6px;margin-bottom:14px;}
    .inputRow{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
    .inputRow input{flex:1;}
    .btnSubtle{padding:9px 10px;font-size:12px;white-space:nowrap;}
    .authBox{
      border:1px solid var(--border);
      background: color-mix(in srgb, var(--panel) 86%, transparent);
      border-radius:16px;
      padding:12px;
      margin-bottom:14px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .authRow{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;}
    .authTitle{font-weight:700;font-size:13px;}
    .authSub{color:var(--muted);font-size:12px;}
    label{font-size:12px;color:var(--muted);}

    input{
      width:100%;
      padding:11px 12px;
      border-radius:14px;
      border:1px solid color-mix(in srgb, var(--border) 90%, transparent);
      background: color-mix(in srgb, var(--panel) 80%, transparent);
      color:var(--text);
      outline:none;
      transition:.15s;
    }

    input:focus{
      border-color:color-mix(in srgb, var(--accent) 70%, transparent);
      box-shadow:0 0 0 4px color-mix(in srgb, var(--accent) 18%, transparent);
    }

    .hint{font-size:12px;color:var(--muted);margin-top:-6px;}

    button{
      border:1px solid color-mix(in srgb, var(--border) 90%, transparent);
      background: linear-gradient(180deg, color-mix(in srgb, var(--accent) 14%, transparent), color-mix(in srgb, var(--panel) 70%, transparent));
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:600;
      letter-spacing:-.01em;
      transition:.15s;
      user-select:none;
    }
    button:hover{transform: translateY(-1px); border-color:color-mix(in srgb, var(--accent) 55%, transparent);}
    button:active{transform: translateY(0);}

    button.isDisabled,
    .slot.isDisabled{
      opacity:.6;
      cursor:not-allowed;
      transform:none;
    }
    button.isDisabled:hover,
    .slot.isDisabled:hover{
      transform:none;
      border-color:color-mix(in srgb, var(--border) 90%, transparent);
    }

    .btnDanger{
      background: linear-gradient(180deg, color-mix(in srgb, var(--bad) 12%, transparent), color-mix(in srgb, var(--panel) 70%, transparent));
    }

    .row{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;}

    .slotGrid{
      padding:14px 14px 16px;
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap:10px;
    }
    @media (max-width: 560px){ .slotGrid{grid-template-columns: repeat(2, minmax(0, 1fr));} }

    .slot{
      border:1px solid color-mix(in srgb, var(--border) 78%, transparent);
      background: var(--slotBg);
      border-radius:16px;
      padding:10px 10px;
      cursor:pointer;
      transition:.15s;
      display:flex;
      flex-direction:column;
      gap:6px;
      min-height:74px;
      text-align:left;
    }

    .slot:hover{
      transform: translateY(-1px);
      border-color:color-mix(in srgb, var(--accent) 55%, transparent);
      background: var(--slotBgHover);
    }

    .slot.selected{
      border-color:color-mix(in srgb, var(--good) 65%, transparent);
      box-shadow:0 0 0 4px color-mix(in srgb, var(--good) 14%, transparent);
      background: var(--slotSelBg);
    }

    .slot.common{
      border-color: color-mix(in srgb, var(--accent) 65%, transparent);
      box-shadow:0 0 0 4px color-mix(in srgb, var(--accent) 14%, transparent);
      background: var(--slotComBg);
    }

    .slot .top{display:flex;align-items:center;justify-content:space-between;gap:10px;}
    .slot .labelEt{font-weight:800;font-size:13px;}
    .slot .labelLocal{font-family:var(--mono);font-size:11px;color:var(--muted);}

    .count{font-size:11px;color:var(--muted);display:flex;align-items:center;gap:6px;white-space:nowrap;}
    .miniBar{width:46px;height:6px;border-radius:999px;background: color-mix(in srgb, var(--border) 70%, transparent);overflow:hidden;}
    .miniBar > span{display:block;height:100%;width:0;background: linear-gradient(90deg, color-mix(in srgb, var(--accent) 85%, transparent), color-mix(in srgb, var(--accent2) 85%, transparent));}

    .legend{
      padding:12px 14px 14px;
      border-top:1px solid color-mix(in srgb, var(--border) 72%, transparent);
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }

    .key{display:flex;gap:12px;flex-wrap:wrap;align-items:center;}
    .keyItem{display:flex;gap:8px;align-items:center;color:var(--muted);font-size:12px;}
    .swatch{width:10px;height:10px;border-radius:4px;border:1px solid color-mix(in srgb, var(--border) 90%, transparent);}
    .swSel{background:color-mix(in srgb, var(--good) 22%, transparent); border-color:color-mix(in srgb, var(--good) 70%, transparent);}
    .swCom{background:color-mix(in srgb, var(--accent) 20%, transparent); border-color:color-mix(in srgb, var(--accent) 70%, transparent);}

    .footerPanel{margin-top:14px;}

    .members{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:10px;
      padding:14px;
    }
    @media (max-width: 760px){ .members{grid-template-columns:1fr;} }

    .memberCard{
      border:1px solid color-mix(in srgb, var(--border) 72%, transparent);
      background: var(--slotBg);
      border-radius:16px;
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height:86px;
    }

    .memberTop{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;}
    .memberName{font-weight:800;}
    .memberEmail{color:var(--muted);font-size:12px;word-break:break-all;}

    .chips{display:flex;gap:8px;flex-wrap:wrap;}
    .chip{
      font-family:var(--mono);
      font-size:11px;
      color:var(--text);
      background: color-mix(in srgb, var(--accent) 12%, transparent);
      border:1px solid color-mix(in srgb, var(--accent) 20%, transparent);
      padding:6px 8px;
      border-radius:999px;
    }
    .chip.none{
      color:var(--muted);
      background: color-mix(in srgb, var(--border) 22%, transparent);
      border-color: color-mix(in srgb, var(--border) 40%, transparent);
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background: var(--toastBg);
      border:1px solid color-mix(in srgb, var(--border) 72%, transparent);
      padding:10px 12px;
      border-radius:999px;
      color:var(--text);
      font-size:12.5px;
      box-shadow:var(--shadow);
      display:none;
      gap:10px;
      align-items:center;
      z-index:50;
      backdrop-filter: blur(10px);
    }
    .toast.show{display:flex;}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Team Scheduling Tool</h1>
        <div class="subtitle">
          Select your preferred 1-hour meeting slots (Eastern Time + your local time). The team list updates as people submit.
        </div>

        <div class="badgeRow">
          <div class="pill"><span class="dot"></span><span><b>Scheduling closes:</b> May 15, 2026</span></div>
          <div class="pill"><span class="dot" id="scheduleDot" style="background:var(--good)"></span><span id="schedulePill">Scheduling open</span></div>
          <div class="pill"><span class="dot" style="background:var(--good)"></span><span id="tzPill">Your time zone: …</span></div>
          <div class="pill"><span class="dot" style="background:var(--accent2)"></span><span>Slots: 9:00 AM–5:00 PM ET (last start 4:00 PM)</span></div>
        </div>
      </div>

      <div style="display:flex;flex-direction:column;align-items:flex-end;gap:10px">
        <button id="themeBtn" type="button" style="padding:9px 10px">Toggle light/dark theme</button>
      </div>
    </header>

    <div class="grid">
      <!-- Identity -->
      <section class="panel">
        <div class="panelHead">
          <div>
            <h2>Your info</h2>
            <p>Selections are scoped by room code.</p>
          </div>
        </div>

        <div class="panelBody">
          <div class="authBox">
            <div class="authRow">
              <div>
                <div class="authTitle">Access</div>
                <div class="authSub" id="authStatus">Not signed in</div>
              </div>
              <button id="signOutBtn" class="btnSubtle" type="button" style="display:none">Sign out</button>
            </div>
            <div id="authControls">
              <div class="field">
                <label for="authEmail">Login email</label>
                <input id="authEmail" type="email" placeholder="you@company.com" autocomplete="email" />
              </div>
              <div class="field">
                <label for="authPassword">Password</label>
                <input id="authPassword" type="password" placeholder="••••••••" autocomplete="current-password" />
              </div>
              <div class="row" style="justify-content:flex-start">
                <button id="signInBtn" type="button">Sign in</button>
                <button id="signUpBtn" type="button">Create account</button>
                <button id="emailLinkBtn" type="button">Email link</button>
                <button id="googleBtn" type="button">Google sign-in</button>
              </div>
              <div class="hint">Passwordless: enter your email, then click Email link.</div>
            </div>
            <div class="hint">Sign in to view and save room selections.</div>
          </div>

          <div class="field">
            <label for="room">Room code / Team name</label>
            <div class="inputRow">
              <input id="room" placeholder="e.g., physics-lab / team-standup" autocomplete="off" required />
              <button id="copyRoomBtn" class="btnSubtle" type="button">Copy</button>
            </div>
            <div class="hint">Room codes are lowercased; spaces become hyphens.</div>
          </div>

          <div class="field">
            <label for="name">Name</label>
            <input id="name" placeholder="e.g., Alex Johnson" autocomplete="name" />
          </div>

          <div class="field">
            <label for="email">Email</label>
            <input id="email" placeholder="e.g., alex@company.com" autocomplete="email" inputmode="email" />
            <div class="hint">Your sign-in email is used when available.</div>
          </div>

          <div class="row" style="margin-top:14px">
            <button id="saveBtn" type="button">Save / Update</button>
            <button id="clearMeBtn" class="btnDanger" type="button">Clear my picks</button>
          </div>
        </div>
      </section>

      <!-- Slots -->
      <section class="panel">
        <div class="panelHead">
          <div>
            <h2>Select 1-hour slots</h2>
            <p>ET shown in bold; your local time below.</p>
          </div>
          <div style="text-align:right">
            <div style="color:var(--muted); font-size:12px">Members submitted</div>
            <div style="font-weight:900; font-size:20px" id="memberCount">0</div>
          </div>
        </div>

        <div class="slotGrid" id="slotGrid"></div>

        <div class="legend">
          <div class="key">
            <div class="keyItem"><span class="swatch swSel"></span> Selected by you</div>
            <div class="keyItem"><span class="swatch swCom"></span> Selected by everyone</div>
          </div>
          <div class="keyItem" style="gap:10px">
            <span style="color:var(--muted)">Show times in:</span>
            <button id="toggleLocal" type="button" style="padding:9px 10px">Your local time</button>
          </div>
        </div>
      </section>
    </div>

    <!-- Team list -->
    <section class="panel footerPanel">
      <div class="panelHead">
        <div>
          <h2>Current team selections (this room)</h2>
          <p>Watch convergence by finding slots selected by everyone.</p>
        </div>
        <div class="row" style="gap:10px">
          <button id="exportBtn" type="button">Export JSON</button>
          <div class="pill"><span class="dot" style="background:var(--bad)"></span><span>Room reset requires admin</span></div>
        </div>
      </div>

      <div class="members" id="members"></div>
    </section>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite">
    <span id="toastMsg"></span>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signInWithPopup, GoogleAuthProvider, signOut, sendSignInLinkToEmail, isSignInWithEmailLink, signInWithEmailLink } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getFirestore, doc, setDoc, collection, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD7cfuYuOYIUoLavGJlfua4UYfawDcZMT0",
      authDomain: "team-scheduler-7ddab.firebaseapp.com",
      projectId: "team-scheduler-7ddab",
      storageBucket: "team-scheduler-7ddab.firebasestorage.app",
      messagingSenderId: "986652351844",
      appId: "1:986652351844:web:09874d46b6e10b4572ae71",
      measurementId: "G-72MHNL8GFY"
    };

    const THEME_KEY = "teamScheduler_theme";
    const EMAIL_LINK_KEY = "teamScheduler_emailLink";

    // 1-hour slots starting in ET, 9..16 inclusive
    const SLOT_START_HOURS_ET = Array.from({length: 8}, (_, i) => 9 + i);
    const REF_DATE = { year: 2026, month: 5, day: 1 }; // stable conversion date
    const SCHEDULE_CLOSE_ET = makeZonedDate(2026, 5, 15, 23, 59, "America/New_York", 59);

    const elRoom = document.getElementById("room");
    const elName = document.getElementById("name");
    const elEmail = document.getElementById("email");
    const elSlotGrid = document.getElementById("slotGrid");
    const elMembers = document.getElementById("members");
    const elMemberCount = document.getElementById("memberCount");
    const elTzPill = document.getElementById("tzPill");
    const elSchedulePill = document.getElementById("schedulePill");
    const elScheduleDot = document.getElementById("scheduleDot");

    const elSaveBtn = document.getElementById("saveBtn");
    const elClearMeBtn = document.getElementById("clearMeBtn");
    const elExportBtn = document.getElementById("exportBtn");
    const elToggleLocal = document.getElementById("toggleLocal");
    const elThemeBtn = document.getElementById("themeBtn");
    const elCopyRoomBtn = document.getElementById("copyRoomBtn");
    const elAuthEmail = document.getElementById("authEmail");
    const elAuthPassword = document.getElementById("authPassword");
    const elSignInBtn = document.getElementById("signInBtn");
    const elSignUpBtn = document.getElementById("signUpBtn");
    const elEmailLinkBtn = document.getElementById("emailLinkBtn");
    const elGoogleBtn = document.getElementById("googleBtn");
    const elSignOutBtn = document.getElementById("signOutBtn");
    const elAuthStatus = document.getElementById("authStatus");
    const elAuthControls = document.getElementById("authControls");

    const elToast = document.getElementById("toast");
    const elToastMsg = document.getElementById("toastMsg");

    const userTz = Intl.DateTimeFormat().resolvedOptions().timeZone || "Local";
    elTzPill.textContent = `Your time zone: ${userTz}`;

    let showLocal = true;
    let userSelections = new Set();
    let activeRoom = "";
    let roomMembers = {};
    let roomUnsub = null;
    let scheduleClosed = false;
    let app = null;
    let auth = null;
    let authUser = null;
    let db = null;
    let roomDebounce = null;

    // ---------- Theme ----------
    function applyTheme(theme){
      if(theme === "dark") document.documentElement.setAttribute("data-theme","dark");
      else document.documentElement.removeAttribute("data-theme");
      localStorage.setItem(THEME_KEY, theme);
    }

    function toggleTheme(){
      const isDark = document.documentElement.getAttribute("data-theme") === "dark";
      applyTheme(isDark ? "light" : "dark");
      toast(isDark ? "Light theme" : "Dark theme");
    }

    function initTheme(){
      const saved = localStorage.getItem(THEME_KEY);
      if(saved === "dark" || saved === "light") applyTheme(saved);
      else {
        const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
        applyTheme(prefersDark ? "dark" : "light");
      }
    }

    // ---------- Toast ----------
    function toast(msg){
      elToastMsg.textContent = msg;
      elToast.classList.add("show");
      clearTimeout(toast._t);
      toast._t = setTimeout(()=> elToast.classList.remove("show"), 1800);
    }

    async function copyRoomCode(){
      const rk = roomKey();
      if(!rk) return toast("Enter a room code first.");
      elRoom.value = rk;
      onRoomCommit();

      const ok = await copyToClipboard(rk);
      toast(ok ? "Room code copied." : "Copy failed.");
    }

    async function copyToClipboard(text){
      if(navigator.clipboard && window.isSecureContext){
        try{
          await navigator.clipboard.writeText(text);
          return true;
        }catch{}
      }
      return fallbackCopy(text);
    }

    function fallbackCopy(text){
      const ta = document.createElement("textarea");
      ta.value = text;
      ta.setAttribute("readonly", "");
      ta.style.position = "fixed";
      ta.style.left = "-9999px";
      document.body.appendChild(ta);
      ta.select();
      let ok = false;
      try{
        ok = document.execCommand("copy");
      }catch{}
      ta.remove();
      return ok;
    }

    // ---------- Firebase ----------
    function initFirebase(){
      try{
        if(!firebaseConfig || !firebaseConfig.apiKey) throw new Error("Missing Firebase config");
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        initAuth();
      }catch(err){
        console.warn("Firebase init failed. Paste your config in index.html.", err);
      }
    }

    function ensureDb(showToast=true){
      if(db) return true;
      if(showToast) toast("Add Firebase config first.");
      return false;
    }

    function ensureAuth(showToast=true){
      if(authUser) return true;
      if(showToast) toast("Sign in to access this room.");
      return false;
    }

    function initAuth(){
      if(!auth) return;
      onAuthStateChanged(auth, (user) => {
        authUser = user || null;
        updateAuthUI();

        if(authUser && authUser.email){
          elEmail.value = authUser.email.toLowerCase();
          elEmail.readOnly = true;
        }else{
          elEmail.readOnly = false;
        }

        if(authUser && authUser.displayName && !elName.value.trim()){
          elName.value = authUser.displayName;
        }

        if(!authUser && roomUnsub){
          roomUnsub();
          roomUnsub = null;
        }

        if(!authUser){
          roomMembers = {};
          userSelections = new Set();
        }

        setRoomFromInput();
        updateActionState();
        renderAll();
      });
    }

    function updateAuthUI(){
      if(authUser){
        elAuthStatus.textContent = `Signed in as ${authUser.email || "user"}`;
        if(authUser.email) elAuthEmail.value = authUser.email;
        elAuthPassword.value = "";
        elAuthControls.style.display = "none";
        elSignOutBtn.style.display = "inline-flex";
      }else{
        elAuthStatus.textContent = "Not signed in";
        elAuthControls.style.display = "block";
        elSignOutBtn.style.display = "none";
      }
    }

    function authErrorMessage(err){
      const code = err && err.code ? err.code : "";
      const map = {
        "auth/invalid-email": "Enter a valid email address.",
        "auth/user-not-found": "No account found. Use Create account.",
        "auth/wrong-password": "Incorrect password.",
        "auth/email-already-in-use": "Email already in use. Try Sign in.",
        "auth/weak-password": "Password should be at least 6 characters.",
        "auth/popup-closed-by-user": "Popup closed.",
        "auth/unauthorized-domain": "Add this domain to Firebase Auth settings.",
        "auth/account-exists-with-different-credential": "Account exists with a different sign-in method.",
        "auth/operation-not-allowed": "Enable this sign-in method in Firebase Auth.",
        "auth/invalid-action-code": "Invalid or expired email link.",
        "auth/expired-action-code": "Email link expired. Request a new one.",
        "auth/invalid-continue-uri": "Invalid sign-in link URL. Check authorized domains."
      };
      return map[code] || "Authentication failed.";
    }

    async function signInEmail(){
      if(!auth) return toast("Add Firebase config first.");
      const email = elAuthEmail.value.trim();
      const password = elAuthPassword.value;
      if(!email || !password) return toast("Enter email and password.");
      try{
        await signInWithEmailAndPassword(auth, email, password);
        elAuthPassword.value = "";
        toast("Signed in.");
      }catch(err){
        toast(authErrorMessage(err));
      }
    }

    async function signUpEmail(){
      if(!auth) return toast("Add Firebase config first.");
      const email = elAuthEmail.value.trim();
      const password = elAuthPassword.value;
      if(!email || !password) return toast("Enter email and password.");
      try{
        await createUserWithEmailAndPassword(auth, email, password);
        elAuthPassword.value = "";
        toast("Account created.");
      }catch(err){
        toast(authErrorMessage(err));
      }
    }

    function getActionUrl(){
      if(window.location.protocol === "file:" || window.location.origin === "null") return "";
      return `${window.location.origin}${window.location.pathname}`;
    }

    async function sendEmailLink(){
      if(!auth) return toast("Add Firebase config first.");
      const email = elAuthEmail.value.trim();
      if(!email) return toast("Enter your email first.");

      const actionUrl = getActionUrl();
      if(!actionUrl) return toast("Email link requires a hosted URL (not file://).");

      try{
        await sendSignInLinkToEmail(auth, email, {
          url: actionUrl,
          handleCodeInApp: true
        });
        localStorage.setItem(EMAIL_LINK_KEY, email);
        toast("Email link sent. Check your inbox.");
      }catch(err){
        toast(authErrorMessage(err));
      }
    }

    async function handleEmailLinkSignIn(){
      if(!auth || !isSignInWithEmailLink(auth, window.location.href)) return;
      let email = localStorage.getItem(EMAIL_LINK_KEY) || elAuthEmail.value.trim();
      if(!email){
        email = window.prompt("Confirm your email to finish sign-in") || "";
      }
      if(!email) return toast("Email required to finish sign-in.");

      try{
        await signInWithEmailLink(auth, email, window.location.href);
        localStorage.removeItem(EMAIL_LINK_KEY);
        toast("Signed in.");
        if(window.history && window.history.replaceState){
          const cleanUrl = `${window.location.origin}${window.location.pathname}`;
          window.history.replaceState({}, document.title, cleanUrl);
        }
      }catch(err){
        toast(authErrorMessage(err));
      }
    }

    async function signInGoogle(){
      if(!auth) return toast("Add Firebase config first.");
      try{
        const provider = new GoogleAuthProvider();
        await signInWithPopup(auth, provider);
        toast("Signed in.");
      }catch(err){
        toast(authErrorMessage(err));
      }
    }

    async function signOutUser(){
      if(!auth) return;
      try{
        await signOut(auth);
        toast("Signed out.");
      }catch(err){
        toast(authErrorMessage(err));
      }
    }

    // ---------- Room handling ----------
    function normalizeRoom(room){
      return String(room || "")
        .trim()
        .toLowerCase()
        .replace(/\s+/g, "-")
        .replace(/[^a-z0-9-_]/g, "");
    }

    function roomKey(){
      return normalizeRoom(elRoom.value);
    }

    function setRoomFromInput(){
      const normalized = roomKey();
      if(normalized !== elRoom.value) elRoom.value = normalized;
      const needsResubscribe = normalized !== activeRoom || !roomUnsub;
      if(!needsResubscribe) return;

      activeRoom = normalized;

      if(roomUnsub){
        roomUnsub();
        roomUnsub = null;
      }

      roomMembers = {};
      userSelections = new Set();
      renderAll();

      if(!activeRoom) return;
      if(!ensureDb(false) || !ensureAuth(false)) return;

      roomUnsub = onSnapshot(
        collection(db, "rooms", activeRoom, "members"),
        (snapshot) => {
          const nextMembers = {};
          snapshot.forEach((docSnap) => {
            const data = docSnap.data() || {};
            const emailLower = String(data.email || docSnap.id || "").toLowerCase();
            const updatedAt = data.updatedAt && typeof data.updatedAt.toDate === "function"
              ? data.updatedAt.toDate()
              : null;

            nextMembers[emailLower] = {
              name: data.name || "",
              email: emailLower,
              tz: data.tz || "",
              slots: Array.isArray(data.slots) ? data.slots : [],
              updatedAt
            };
          });

          roomMembers = nextMembers;
          syncFromSnapshot();
          renderAll();
        },
        (err) => {
          console.error(err);
          toast("Unable to load room data.");
        }
      );
    }

    function ensureActiveRoom(){
      const rk = roomKey();
      if(!rk) return "";
      if(rk !== activeRoom) setRoomFromInput();
      return rk;
    }

    function getUserEmail(){
      if(authUser && authUser.email) return authUser.email.toLowerCase();
      return elEmail.value.trim().toLowerCase();
    }

    function isValidEmail(email){
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email.trim());
    }

    // ---------- Time labels ----------
    function pad2(n){ return String(n).padStart(2,"0"); }
    function slotKeyFromHour(hour){ return `${pad2(hour)}:00`; }

    function etLabel(hour){
      const h12 = ((hour + 11) % 12) + 1;
      const ampm = hour >= 12 ? "PM" : "AM";
      return `${h12}:00 ${ampm}`;
    }

    function makeZonedDate(year, month, day, hour, minute, timeZone, second = 0){
      const utcGuess = new Date(Date.UTC(year, month-1, day, hour, minute, second));
      const offsetMs = tzOffsetMs(utcGuess, timeZone);
      return new Date(utcGuess.getTime() - offsetMs);
    }

    function tzOffsetMs(date, timeZone){
      const f = new Intl.DateTimeFormat("en-US", {
        timeZone,
        year: "numeric", month: "2-digit", day: "2-digit",
        hour: "2-digit", minute: "2-digit", second: "2-digit",
        hour12: false
      });
      const parts = f.formatToParts(date);
      const get = (t) => Number(parts.find(p => p.type === t).value);
      const asUTC = Date.UTC(get("year"), get("month")-1, get("day"), get("hour"), get("minute"), get("second"));
      return asUTC - date.getTime();
    }

    function etToLocalLabel(hourEt){
      const d = makeZonedDate(REF_DATE.year, REF_DATE.month, REF_DATE.day, hourEt, 0, "America/New_York");
      return new Intl.DateTimeFormat(undefined, {
        hour:"numeric", minute:"2-digit", hour12:true, timeZone:userTz
      }).format(d);
    }

    function isSchedulingClosed(){
      return Date.now() >= SCHEDULE_CLOSE_ET.getTime();
    }

    function isInteractionLocked(){
      return scheduleClosed || !authUser;
    }

    function updateScheduleStatus(){
      scheduleClosed = isSchedulingClosed();
      elSchedulePill.textContent = scheduleClosed ? "Scheduling closed" : "Scheduling open";
      elScheduleDot.style.background = scheduleClosed ? "var(--bad)" : "var(--good)";
      updateActionState();
    }

    function updateActionState(){
      const disabled = isInteractionLocked();
      [elSaveBtn, elClearMeBtn].forEach((btn) => {
        btn.classList.toggle("isDisabled", disabled);
        btn.disabled = disabled;
        btn.setAttribute("aria-disabled", disabled ? "true" : "false");
      });
      renderSlots();
    }

    // ---------- Counts / common slots ----------
    function computeCounts(){
      const members = Object.values(roomMembers);
      const counts = {};
      SLOT_START_HOURS_ET.forEach(h => counts[slotKeyFromHour(h)] = 0);

      for(const m of members){
        if(!Array.isArray(m.slots)) continue;
        for(const s of m.slots){
          if(counts[s] !== undefined) counts[s] += 1;
        }
      }
      return { counts, memberCount: members.length };
    }

    function commonSlots(){
      const { counts, memberCount } = computeCounts();
      if(memberCount === 0) return new Set();
      const common = new Set();
      for(const k of Object.keys(counts)){
        if(counts[k] === memberCount) common.add(k);
      }
      return common;
    }

    // ---------- Rendering ----------
    function renderSlots(){
      elSlotGrid.innerHTML = "";
      const { counts, memberCount } = computeCounts();
      const common = commonSlots();
      const locked = isInteractionLocked();

      for(const hourEt of SLOT_START_HOURS_ET){
        const key = slotKeyFromHour(hourEt);

        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "slot";
        if(locked){
          btn.classList.add("isDisabled");
          btn.disabled = true;
        }

        if(userSelections.has(key)) btn.classList.add("selected");
        if(common.has(key) && memberCount > 0) btn.classList.add("common");

        const local = etToLocalLabel(hourEt);
        const count = counts[key] || 0;
        const pct = memberCount ? Math.round((count / memberCount) * 100) : 0;

        btn.innerHTML = `
          <div class="top">
            <div class="labelEt">${etLabel(hourEt)} ET</div>
            <div class="count">
              <span>${count}/${memberCount || 0}</span>
              <span class="miniBar" aria-hidden="true"><span style="width:${pct}%"></span></span>
            </div>
          </div>
          <div class="labelLocal" style="display:${showLocal ? "block":"none"}">${local} (your time)</div>
          <div class="labelLocal" style="display:${showLocal ? "none":"block"}">${etLabel(hourEt)} (ET)</div>
        `;

        btn.addEventListener("click", () => {
          if(isInteractionLocked()) return toast(scheduleClosed ? "Scheduling is closed." : "Sign in to continue.");
          if(!ensureActiveRoom()) return toast("Enter a room code first.");
          toggleSlot(key);
        });

        elSlotGrid.appendChild(btn);
      }
    }

    function renderMembers(){
      const members = Object.values(roomMembers);
      elMemberCount.textContent = members.length;

      elMembers.innerHTML = "";

      if(!activeRoom){
        elMembers.innerHTML = `<div class="memberCard"><div class="memberName">Enter a room code to begin</div><div class="memberEmail">Team selections are scoped per room code.</div></div>`;
        return;
      }

      if(!authUser){
        elMembers.innerHTML = `<div class="memberCard"><div class="memberName">Sign in required</div><div class="memberEmail">Sign in to view and save room data.</div></div>`;
        return;
      }

      if(!db){
        elMembers.innerHTML = `<div class="memberCard"><div class="memberName">Firebase not configured</div><div class="memberEmail">Paste your config in index.html to load room data.</div></div>`;
        return;
      }

      if(members.length === 0){
        elMembers.innerHTML = `<div class="memberCard"><div class="memberName">No submissions yet</div><div class="memberEmail">Once someone saves their picks, they’ll appear here.</div></div>`;
        return;
      }

      members.sort((a,b) => (b.updatedAt ? b.updatedAt.getTime() : 0) - (a.updatedAt ? a.updatedAt.getTime() : 0));

      for(const m of members){
        const chips = (m.slots && m.slots.length)
          ? m.slots.slice().sort().map(s => `<span class="chip">${slotLabelCompact(s)}</span>`).join("")
          : `<span class="chip none">No slots selected</span>`;

        const updated = m.updatedAt || null;

        const card = document.createElement("div");
        card.className = "memberCard";
        card.innerHTML = `
          <div class="memberTop">
            <div>
              <div class="memberName">${escapeHtml(m.name || "Unnamed")}</div>
              <div class="memberEmail">${escapeHtml(m.email || "")}</div>
            </div>
            <div style="text-align:right">
              <div style="color:var(--muted); font-size:11px">${escapeHtml(m.tz || "")}</div>
              <div style="color:var(--muted); font-size:11px">${escapeHtml(updated ? updated.toLocaleString() : "")}</div>
            </div>
          </div>
          <div class="chips">${chips}</div>
        `;
        elMembers.appendChild(card);
      }
    }

    function slotLabelCompact(slotKey){
      const hour = Number(slotKey.slice(0,2));
      const h12 = ((hour + 11) % 12) + 1;
      const ampm = hour >= 12 ? "PM" : "AM";
      return `${h12}${ampm} ET`;
    }

    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function renderAll(){
      renderSlots();
      renderMembers();
    }

    // ---------- Interaction ----------
    function toggleSlot(key){
      if(userSelections.has(key)) userSelections.delete(key);
      else userSelections.add(key);
      renderSlots();
      autoSaveIfIdentified();
    }

    function autoSaveIfIdentified(){
      if(scheduleClosed || !db || !authUser) return;
      const rk = roomKey();
      const name = elName.value.trim();
      const email = getUserEmail();
      if(!rk || !name || !isValidEmail(email)) return;
      if(rk !== activeRoom) setRoomFromInput();
      void saveMe(false);
    }

    async function saveMe(showToast=true){
      if(scheduleClosed) return toast("Scheduling is closed.");
      const rk = ensureActiveRoom();
      const name = elName.value.trim();
      const email = getUserEmail();

      if(!rk) return toast("Please enter a room code.");
      if(!name) return toast("Please enter your name.");
      if(!isValidEmail(email)) return toast("Please enter a valid email.");
      if(!ensureDb()) return;
      if(!ensureAuth()) return;

      const payload = {
        name,
        email,
        tz: userTz,
        slots: Array.from(userSelections),
        updatedAt: serverTimestamp()
      };

      try{
        await setDoc(doc(db, "rooms", rk, "members", email), payload, { merge: true });
        if(showToast) toast("Saved.");
      }catch(err){
        console.error(err);
        toast("Save failed.");
      }
    }

    async function clearMyPicks(){
      if(scheduleClosed) return toast("Scheduling is closed.");
      const rk = ensureActiveRoom();
      const name = elName.value.trim();
      const email = getUserEmail();

      if(!rk) return toast("Please enter a room code.");
      if(!name) return toast("Please enter your name.");
      if(!isValidEmail(email)) return toast("Please enter a valid email.");
      if(!ensureDb()) return;
      if(!ensureAuth()) return;

      userSelections = new Set();
      renderSlots();

      const payload = {
        name,
        email,
        tz: userTz,
        slots: [],
        updatedAt: serverTimestamp()
      };

      try{
        await setDoc(doc(db, "rooms", rk, "members", email), payload, { merge: true });
        toast("Cleared your picks.");
      }catch(err){
        console.error(err);
        toast("Clear failed.");
      }
    }

    function exportJson(){
      const rk = ensureActiveRoom();
      if(!rk) return toast("Enter a room code first.");
      if(!ensureDb()) return;
      if(!ensureAuth()) return;

      const members = {};
      for(const [email, m] of Object.entries(roomMembers)){
        members[email] = {
          name: m.name || "",
          email: m.email || email,
          tz: m.tz || "",
          slots: Array.isArray(m.slots) ? m.slots : [],
          updatedAt: m.updatedAt ? m.updatedAt.toISOString() : null
        };
      }

      const payload = {
        room: rk,
        exportedAt: new Date().toISOString(),
        members
      };

      const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `team-schedule-${rk}-${new Date().toISOString().slice(0,10)}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      toast("Exported.");
    }

    function toggleLocal(){
      showLocal = !showLocal;
      elToggleLocal.textContent = showLocal ? "Your local time" : "Eastern Time";
      renderSlots();
    }

    function syncFromSnapshot(){
      if(!authUser) return;
      const email = getUserEmail();
      if(!isValidEmail(email)) return;

      const me = roomMembers[email];
      if(!me) return;

      if(!elName.value.trim()) elName.value = me.name || "";
      userSelections = new Set(Array.isArray(me.slots) ? me.slots : []);
    }

    function maybePrefill(){
      if(!activeRoom) return;
      syncFromSnapshot();
      renderAll();
    }

    function onRoomInput(){
      clearTimeout(roomDebounce);
      roomDebounce = setTimeout(setRoomFromInput, 250);
    }

    function onRoomCommit(){
      clearTimeout(roomDebounce);
      setRoomFromInput();
    }

    // ---------- Wiring ----------
    elSaveBtn.addEventListener("click", () => void saveMe(true));
    elClearMeBtn.addEventListener("click", () => void clearMyPicks());
    elExportBtn.addEventListener("click", exportJson);
    elToggleLocal.addEventListener("click", toggleLocal);
    elThemeBtn.addEventListener("click", toggleTheme);
    elCopyRoomBtn.addEventListener("click", copyRoomCode);
    elSignInBtn.addEventListener("click", () => void signInEmail());
    elSignUpBtn.addEventListener("click", () => void signUpEmail());
    elEmailLinkBtn.addEventListener("click", () => void sendEmailLink());
    elGoogleBtn.addEventListener("click", () => void signInGoogle());
    elSignOutBtn.addEventListener("click", () => void signOutUser());

    elRoom.addEventListener("input", onRoomInput);
    elRoom.addEventListener("blur", onRoomCommit);
    elRoom.addEventListener("keydown", (e) => { if(e.key === "Enter") { e.preventDefault(); onRoomCommit(); } });

    elEmail.addEventListener("blur", maybePrefill);
    elEmail.addEventListener("keydown", (e) => { if(e.key === "Enter") { e.preventDefault(); maybePrefill(); } });

    elName.addEventListener("input", autoSaveIfIdentified);
    elEmail.addEventListener("input", autoSaveIfIdentified);
    elAuthPassword.addEventListener("keydown", (e) => {
      if(e.key === "Enter"){
        e.preventDefault();
        void signInEmail();
      }
    });

    // ---------- Init ----------
    (function init(){
      initTheme();
      initFirebase();
      handleEmailLinkSignIn();
      updateScheduleStatus();
      setRoomFromInput();
      renderAll();
      setInterval(updateScheduleStatus, 60 * 1000);
    })();
  </script>
</body>
</html>

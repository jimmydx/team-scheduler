<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Team Scheduler</title>
  <link rel="icon" href="favicon.ico" />
  <link rel="icon" type="image/png" sizes="32x32" href="assets/TS-icon-32x32.png?v=1" />
  <link rel="icon" type="image/png" sizes="16x16" href="assets/TS-icon-32x32.png?v=1" />
  <link rel="shortcut icon" href="assets/TS-icon-32x32.png?v=1" />
  <link rel="apple-touch-icon" sizes="180x180" href="assets/TS-icon-1024x1024.png" />

  <style>
    /* Theme tokens
       - default: light
       - dark theme: html[data-theme="dark"]
    */

    :root{
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";

      /* Light theme */
      --bg:#f6f8fc;
      --panel:#ffffff;
      --panel2:#ffffff;
      --text:#0f172a;
      --muted:#475569;
      --border:rgba(15,23,42,.14);
      --accent:#0284c7;
      --accent2:#7c3aed;
      --star:#fde68a;
      --good:#059669;
      --bad:#e11d48;
      --shadow: 0 12px 30px rgba(2,6,23,.10);

      --slotBg: rgba(2,6,23,.03);
      --slotBgHover: rgba(2,132,199,.06);
      --slotSelBg: rgba(5,150,105,.10);
      --slotComBg: rgba(2,132,199,.08);
      --toastBg: rgba(255,255,255,.92);

      --radius: 18px;
      --radius2: 22px;
    }

    html[data-theme="dark"]{
      --bg:#0b0f19;
      --panel:#10182a;
      --panel2:#0f1729;
      --text:#e9eef9;
      --muted:#94a3b8;
      --border:rgba(148,163,184,.22);
      --accent:#7dd3fc;
      --accent2:#c084fc;
      --star:#fde68a;
      --good:#34d399;
      --bad:#fb7185;
      --shadow: 0 12px 30px rgba(0,0,0,.35);

      --slotBg: rgba(10,14,24,.46);
      --slotBgHover: rgba(125,211,252,.12);
      --slotSelBg: rgba(52,211,153,.10);
      --slotComBg: rgba(125,211,252,.10);
      --toastBg: rgba(15,23,41,.90);
    }

    *{box-sizing:border-box}
    html,body{height:100%}

    body{
      margin:0;
      font-family:var(--sans);
      background:
        radial-gradient(1200px 700px at 20% 10%, color-mix(in srgb, var(--accent) 20%, transparent), transparent 60%),
        radial-gradient(1000px 650px at 85% 15%, color-mix(in srgb, var(--accent2) 18%, transparent), transparent 55%),
        linear-gradient(180deg, color-mix(in srgb, var(--bg) 92%, #ffffff) 0%, var(--bg) 100%);
      color:var(--text);
      line-height:1.35;
    }

    .wrap{max-width:1100px;margin:0 auto;padding:28px 18px 54px;}

    header{
      display:flex;
      gap:18px;
      align-items:flex-start;
      justify-content:space-between;
      margin-bottom:18px;
    }
    .brand{display:flex;flex-direction:column;gap:10px;align-items:flex-start;}
    .brandTop{display:flex;gap:14px;align-items:center;}
    .brandLogo{
      width:54px;
      height:54px;
      border-radius:16px;
      object-fit:cover;
      box-shadow:var(--shadow);
    }

    h1{
      margin:0;
      font-size: clamp(22px, 4vw, 34px);
      letter-spacing:-.02em;
    }

    .subtitle{color:var(--muted);font-size:14px;margin-top:6px;}

    .badgeRow{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px;}
    .pill{
      border:1px solid var(--border);
      background:color-mix(in srgb, var(--panel) 86%, transparent);
      padding:8px 10px;
      border-radius:999px;
      color:var(--muted);
      font-size:12px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .dot{width:8px;height:8px;border-radius:99px;background:var(--accent);}

    .grid{
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:14px;
    }
    @media (max-width: 980px){ .grid{grid-template-columns:1fr;} }
    .leftStack{display:grid;gap:14px;}

    .panel{
      background: linear-gradient(180deg, color-mix(in srgb, var(--panel) 92%, transparent), color-mix(in srgb, var(--panel2) 88%, transparent));
      border:1px solid var(--border);
      border-radius:var(--radius2);
      box-shadow:var(--shadow);
      overflow:hidden;
    }

    .panelHead{
      padding:16px 16px 12px;
      border-bottom:1px solid color-mix(in srgb, var(--border) 72%, transparent);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }

    .panelHead h2{margin:0;font-size:16px;letter-spacing:-.01em;}
    .panelHead p{margin:6px 0 0;color:var(--muted);font-size:13px;}
    .panelBody{padding:16px;}

    .field{display:flex;flex-direction:column;gap:6px;margin-bottom:14px;}
    .inputRow{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
    .inputRow input{flex:1;}
    .dateRow{gap:10px;}
    .dateRow input{min-width:140px;}
    .dateSep{color:var(--muted);font-size:12px;white-space:nowrap;}
    .btnSubtle{padding:9px 10px;font-size:12px;white-space:nowrap;}
    .authBox{
      border:1px solid var(--border);
      background: color-mix(in srgb, var(--panel) 86%, transparent);
      border-radius:16px;
      padding:12px;
      margin-bottom:14px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .authRow{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;}
    .authTitle{font-weight:700;font-size:13px;}
    .authSub{color:var(--muted);font-size:12px;}
    .authTop{display:flex;flex-direction:column;gap:10px;}
    .authPrimary{width:100%;}
    .authDivider{
      display:flex;
      align-items:center;
      gap:10px;
      color:var(--muted);
      font-size:12px;
      margin:6px 0;
    }
    .authDivider::before,
    .authDivider::after{
      content:"";
      flex:1;
      height:1px;
      background: color-mix(in srgb, var(--border) 80%, transparent);
    }
    .authActions{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;}
    .authActions button.active{
      border-color:color-mix(in srgb, var(--accent) 55%, transparent);
      background: var(--slotBgHover);
    }
    .authFields{display:none;flex-direction:column;gap:10px;margin-top:6px;}
    .authFields.active{display:flex;}
    .authProfile{margin-top:10px;}
    .authNote{text-align:center;}
    .roomTag{font-weight:700;color:var(--accent);}
    .roomMeta{margin-top:6px;}
    .dayHint{margin-top:0;}

    .dayChoices,
    .dayTabs{display:flex;gap:8px;flex-wrap:wrap;}
    .dayRow{display:flex;align-items:center;gap:8px;flex-wrap:wrap;}
    .dayTabs{flex:1;}
    .commentsToggle{margin-left:auto;white-space:nowrap;}
    .dayChoices{
      flex-wrap:nowrap;
      gap:6px;
      overflow-x:auto;
      padding-bottom:4px;
      scrollbar-width:thin;
    }
    .dayChoice,
    .dayTab{
      border:1px solid color-mix(in srgb, var(--border) 85%, transparent);
      background: var(--slotBg);
      border-radius:999px;
      padding:6px 9px;
      font-size:11px;
      font-weight:600;
      letter-spacing:-.01em;
      cursor:pointer;
    }
    .dayChoice.active,
    .dayTab.active{
      border-color:color-mix(in srgb, var(--accent) 60%, transparent);
      background: var(--slotBgHover);
    }
    .dayTab.hasSelections:not(.active){
      border-color:color-mix(in srgb, var(--good) 60%, transparent);
      background: color-mix(in srgb, var(--good) 12%, transparent);
    }

    .topSlots{
      margin-top:16px;
      padding:12px;
      border-top:1px dashed color-mix(in srgb, var(--border) 65%, transparent);
      display:grid;
      gap:10px;
    }
    .topSlotsHeader{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;}
    .topSlotsHead{display:flex;flex-direction:column;gap:2px;}
    .topSlotsTitle{
      font-size:12px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.08em;
    }
    .topSlotsSub{font-size:11px;color:var(--muted);}
    .topToggle{display:flex;gap:6px;flex-wrap:wrap;}
    .topToggle button{
      padding:6px 10px;
      font-size:11px;
      border-radius:999px;
      background: var(--slotBg);
      border:1px solid color-mix(in srgb, var(--border) 85%, transparent);
    }
    .topToggle button.active{
      border-color:color-mix(in srgb, var(--accent) 60%, transparent);
      background: var(--slotBgHover);
    }
    .topSlotsList{display:grid;gap:8px;}
    .topSlot{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid color-mix(in srgb, var(--border) 70%, transparent);
      background: var(--slotBg);
    }
    .topSlotLabel{font-weight:700;font-size:12px;}
    .topSlotStar{margin-left:6px;color:var(--accent);font-weight:900;}
    .topSlotMeta{display:flex;align-items:center;gap:8px;color:var(--muted);font-size:12px;}
    .topSlot .miniBar{width:64px;}
    .topSlotDetails{display:flex;flex-direction:column;gap:4px;min-width:0;flex:1;}
    .topSlotMissing{
      color:var(--muted);
      font-size:11px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .topSlotEmpty{color:var(--muted);font-size:12px;padding:6px 2px;}
    .topSlotsGraph{display:block;}
    .heatmap{display:grid;gap:10px;--axis-width:52px;}
    .heatmapScroll{overflow-x:auto;padding-bottom:4px;}
    .heatmapGrid,
    .heatmapAxis{
      --day-count: 1;
      display:grid;
      grid-template-columns: var(--axis-width) repeat(var(--day-count), minmax(32px, 1fr));
      gap:4px;
      align-items:center;
    }
    .heatmapAxis{margin-bottom:4px;}
    .heatmapDay{font-size:10px;color:var(--muted);font-weight:600;text-align:center;}
    .heatmapTime{font-size:10px;color:var(--muted);white-space:nowrap;text-align:right;}
    .heatmapCell{
      height:18px;
      border-radius:5px;
      border:1px solid color-mix(in srgb, var(--border) 80%, transparent);
      background: color-mix(in srgb, var(--accent) var(--heat), var(--slotBg));
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .heatmapStar{font-size:12px;color:var(--star);line-height:1;}
    .heatmapLegend{
      display:flex;
      align-items:center;
      gap:8px;
      font-size:11px;
      color:var(--muted);
      padding-left:var(--axis-width);
    }
    .heatmapNote{
      font-size:11px;
      color:var(--muted);
      display:flex;
      align-items:center;
      gap:6px;
      margin-left:auto;
    }
    .heatmapNote .heatmapStar{
      background: color-mix(in srgb, var(--accent) 75%, transparent);
      border-radius:4px;
      padding:1px 4px;
      line-height:1;
    }
    .heatmapScale{
      height:8px;
      width:140px;
      border-radius:999px;
      border:1px solid color-mix(in srgb, var(--border) 80%, transparent);
      background: linear-gradient(90deg,
        color-mix(in srgb, var(--slotBg) 80%, transparent),
        color-mix(in srgb, var(--accent) 85%, transparent)
      );
    }

    .daySwitch{padding:10px 14px 0; display:flex; flex-direction:column; gap:10px;}
    .daySelect{display:none;}
    .timeModeNote{padding:2px 14px 0;margin-top:12px;color:var(--accent);font-weight:700;font-size:12px;}
    .commentsPanel{padding:14px 14px 16px;}
    .memberComment{font-size:12px;color:var(--muted);}
    label{font-size:12px;color:var(--muted);}

    input,
    textarea{
      width:100%;
      padding:11px 12px;
      border-radius:14px;
      border:1px solid color-mix(in srgb, var(--border) 90%, transparent);
      background: color-mix(in srgb, var(--panel) 80%, transparent);
      color:var(--text);
      outline:none;
      transition:.15s;
    }

    textarea{min-height:140px;resize:vertical;}

    input:focus,
    textarea:focus{
      border-color:color-mix(in srgb, var(--accent) 70%, transparent);
      box-shadow:0 0 0 4px color-mix(in srgb, var(--accent) 18%, transparent);
    }

    #room{color:var(--accent);}

    select{
      width:100%;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid color-mix(in srgb, var(--border) 90%, transparent);
      background: color-mix(in srgb, var(--panel) 80%, transparent);
      color:var(--text);
      outline:none;
      transition:.15s;
    }

    select:focus{
      border-color:color-mix(in srgb, var(--accent) 70%, transparent);
      box-shadow:0 0 0 4px color-mix(in srgb, var(--accent) 18%, transparent);
    }

    .hint{font-size:12px;color:var(--muted);margin-top:-6px;}
    .hint.footnote{font-size:11px;color:color-mix(in srgb, var(--muted) 80%, transparent);}

    button{
      border:1px solid color-mix(in srgb, var(--border) 90%, transparent);
      background: linear-gradient(180deg, color-mix(in srgb, var(--accent) 14%, transparent), color-mix(in srgb, var(--panel) 70%, transparent));
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:600;
      letter-spacing:-.01em;
      transition:.15s;
      user-select:none;
    }
    button:hover{transform: translateY(-1px); border-color:color-mix(in srgb, var(--accent) 55%, transparent);}
    button:active{transform: translateY(0);}

    button.isDisabled,
    .slot.isDisabled{
      opacity:.6;
      cursor:not-allowed;
      transform:none;
    }
    button.isDisabled:hover,
    .slot.isDisabled:hover{
      transform:none;
      border-color:color-mix(in srgb, var(--border) 90%, transparent);
    }

    .btnDanger{
      background: linear-gradient(180deg, color-mix(in srgb, var(--bad) 12%, transparent), color-mix(in srgb, var(--panel) 70%, transparent));
    }

    .row{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;}

    .slotGrid{
      padding:14px 14px 16px;
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap:10px;
    }
    @media (max-width: 560px){ .slotGrid{grid-template-columns: repeat(2, minmax(0, 1fr));} }

    .slot{
      border:1px solid color-mix(in srgb, var(--border) 78%, transparent);
      background: var(--slotBg);
      border-radius:16px;
      padding:10px 10px;
      cursor:pointer;
      transition:.15s;
      display:flex;
      flex-direction:column;
      gap:6px;
      min-height:74px;
      text-align:left;
    }

    .slot:hover{
      transform: translateY(-1px);
      border-color:color-mix(in srgb, var(--accent) 55%, transparent);
      background: var(--slotBgHover);
    }

    .slot.selected{
      border-color:color-mix(in srgb, var(--good) 65%, transparent);
      box-shadow:0 0 0 4px color-mix(in srgb, var(--good) 14%, transparent);
      background: var(--slotSelBg);
    }

    .slot.common{
      border-color: color-mix(in srgb, var(--accent) 65%, transparent);
      box-shadow:0 0 0 4px color-mix(in srgb, var(--accent) 14%, transparent);
      background: var(--slotComBg);
    }

    .slot .top{display:flex;align-items:center;justify-content:space-between;gap:10px;}
    .slot .labelEt{font-weight:800;font-size:13px;white-space:nowrap;}
    .slot .labelLocal{font-family:var(--mono);font-size:11px;color:var(--muted);}
    .slot .labelLocal + .labelLocal{margin-top:2px;}

    .count{font-size:11px;color:var(--muted);display:flex;align-items:center;gap:6px;white-space:nowrap;}
    .miniBar{width:40px;height:6px;border-radius:999px;background: color-mix(in srgb, var(--border) 70%, transparent);overflow:hidden;}
    .miniBar > span{display:block;height:100%;width:0;background: linear-gradient(90deg, color-mix(in srgb, var(--accent) 85%, transparent), color-mix(in srgb, var(--accent2) 85%, transparent));}

    .legend{
      padding:12px 14px 14px;
      border-top:1px solid color-mix(in srgb, var(--border) 72%, transparent);
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }

    .key{display:flex;gap:12px;flex-wrap:wrap;align-items:center;}
    .keyItem{display:flex;gap:8px;align-items:center;color:var(--muted);font-size:12px;}
    .swatch{width:10px;height:10px;border-radius:4px;border:1px solid color-mix(in srgb, var(--border) 90%, transparent);}
    .swSel{background:color-mix(in srgb, var(--good) 22%, transparent); border-color:color-mix(in srgb, var(--good) 70%, transparent);}
    .swCom{background:color-mix(in srgb, var(--accent) 20%, transparent); border-color:color-mix(in srgb, var(--accent) 70%, transparent);}

    .footerPanel{margin-top:14px;}

    .members{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:10px;
      padding:14px;
    }
    @media (max-width: 760px){ .members{grid-template-columns:1fr;} }

    .memberCard{
      border:1px solid color-mix(in srgb, var(--border) 72%, transparent);
      background: var(--slotBg);
      border-radius:16px;
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height:86px;
    }

    .memberTop{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;}
    .memberName{font-weight:800;}
    .memberEmail{color:var(--muted);font-size:12px;word-break:break-all;}

    .chips{display:flex;gap:8px;flex-wrap:wrap;}
    .chip{
      font-family:var(--mono);
      font-size:11px;
      color:var(--text);
      background: color-mix(in srgb, var(--accent) 12%, transparent);
      border:1px solid color-mix(in srgb, var(--accent) 20%, transparent);
      padding:6px 8px;
      border-radius:999px;
    }
    .chip.none{
      color:var(--muted);
      background: color-mix(in srgb, var(--border) 22%, transparent);
      border-color: color-mix(in srgb, var(--border) 40%, transparent);
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background: var(--toastBg);
      border:1px solid color-mix(in srgb, var(--border) 72%, transparent);
      padding:10px 12px;
      border-radius:999px;
      color:var(--text);
      font-size:12.5px;
      box-shadow:var(--shadow);
      display:none;
      gap:10px;
      align-items:center;
      z-index:50;
      backdrop-filter: blur(10px);
    }
    .toast.show{display:flex;}

    .cursorHint{
      position:fixed;
      left:0;
      top:0;
      transform:translate(12px, 12px);
      background: var(--toastBg);
      border:1px solid color-mix(in srgb, var(--border) 72%, transparent);
      padding:6px 10px;
      border-radius:999px;
      color:var(--text);
      font-size:11px;
      box-shadow:var(--shadow);
      display:none;
      pointer-events:none;
      white-space:nowrap;
      z-index:60;
      backdrop-filter: blur(10px);
    }
    .cursorHint.show{display:block;}

    .authDebugFoot{
      text-align:right;
      margin-top:12px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="brandTop">
          <img src="assets/TS-icon-1024x1024.png" alt="Team Scheduler logo" class="brandLogo" width="54" height="54" />
          <h1>Team Scheduler</h1>
        </div>
        <div class="subtitle">
          Sign in, enter a room code, and select your available time slots to coordinate a weekly meeting time. The team availability list updates as people submit.
        </div>

        <div class="badgeRow">
          <div class="pill"><span class="dot" style="background:var(--good)"></span><span id="tzPill">Your time zone: …</span></div>
        </div>
      </div>

      <div style="display:flex;flex-direction:column;align-items:flex-end;gap:10px">
        <button id="themeBtn" type="button" style="padding:9px 10px">Toggle light/dark theme</button>
      </div>
    </header>

    <div class="grid">
      <div class="leftStack">
        <section class="panel">
          <div class="panelHead">
            <div>
              <h2>User info</h2>
              <p>Sign in to view and save room selections.</p>
            </div>
          </div>

          <div class="panelBody">
            <div class="authBox">
              <div class="authRow">
                <div>
                  <div class="authTitle">Access</div>
                  <div class="authSub" id="authStatus">Not signed in</div>
                </div>
                <button id="signOutBtn" class="btnSubtle" type="button" style="display:none">Sign out</button>
              </div>
              <div id="authControls">
                <div class="authTop">
                  <button id="googleBtn" class="authPrimary" type="button">Google sign-in</button>
                </div>
                <div class="authDivider"><span>or</span></div>
                <div class="authActions">
                  <button id="signInBtn" type="button" aria-expanded="false">Sign in</button>
                  <button id="signUpBtn" type="button" aria-expanded="false">Create account</button>
                  <button id="emailLinkBtn" type="button" aria-expanded="false">Email link</button>
                </div>
                <div id="authFields" class="authFields" aria-live="polite">
                  <div class="field" id="authEmailField">
                    <label for="authEmail">Login email</label>
                    <input id="authEmail" type="email" placeholder="you@company.com" autocomplete="email" />
                  </div>
                  <div class="field" id="authPasswordField">
                    <label for="authPassword">Password</label>
                    <input id="authPassword" type="password" placeholder="••••••••" autocomplete="current-password" />
                  </div>
                  <div class="row" style="justify-content:flex-start">
                    <button id="authSubmitBtn" type="button">Continue</button>
                  </div>
                  <div class="hint footnote" id="authHint"></div>
                </div>
              </div>
              <div id="authProfile" class="authProfile" style="display:none">
                <div class="field">
                  <label for="name">Display name</label>
                  <input id="name" placeholder="e.g., Alex Johnson" autocomplete="name" />
                  <div class="hint footnote">Shown in the team list.</div>
                </div>
                <div class="field">
                  <label for="tzSelect">Time zone</label>
                  <select id="tzSelect" class="tzSelect" aria-label="Select time zone"></select>
                  <div class="hint footnote">Used for local time display and saved with your entry.</div>
                  <div class="row" style="justify-content:flex-start">
                    <button id="tzResetBtn" class="btnSubtle" type="button">Use device time zone</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <section class="panel">
          <div class="panelHead">
            <div>
              <h2>Room settings</h2>
              <p>Selections are scoped by room code.</p>
            </div>
          </div>

          <div class="panelBody">
            <div class="field">
              <label for="room">Room code / Team name</label>
              <div class="inputRow">
                <input id="room" placeholder="e.g., physics-lab / team-standup" autocomplete="off" required />
                <button id="loadRoomBtn" class="btnSubtle" type="button">Load</button>
              </div>
              <div class="hint footnote">(room codes are lowercased; spaces become hyphens.)</div>
            </div>

            <div class="field">
              <label for="roomTzSelect">Room's default time zone</label>
              <select id="roomTzSelect" class="tzSelect" aria-label="Select room time zone"></select>
            </div>

            <div class="field">
              <label>Scheduled dates</label>
              <div class="inputRow dateRow">
                <input id="roomDateStart" type="date" />
                <span class="dateSep">to</span>
                <input id="roomDateEnd" type="date" />
              </div>
            </div>

            <div class="field">
              <label for="roomMeetingMinutes">Meeting duration (minutes)</label>
              <input id="roomMeetingMinutes" type="number" min="1" step="5" />
            </div>

            <div class="field">
              <label>Active days for current room/team:</label>
              <div class="dayChoices" id="roomDays"></div>
            </div>

            <div class="field">
              <label>Room status</label>
              <div class="row" style="justify-content:flex-start">
                <div class="pill">
                  <span class="dot" id="roomStatusDot" style="background:var(--good)"></span>
                  <span id="roomStatusLabel">Room open</span>
                </div>
                <button id="roomToggleBtn" type="button">Close room</button>
              </div>
              <div class="hint footnote roomMeta" id="roomStatusMeta" style="display:none"></div>
            </div>

            <div class="row" style="margin-top:14px">
              <button id="saveBtn" type="button">Save / Update</button>
              <button id="clearMeBtn" class="btnDanger" type="button">Clear my picks</button>
            </div>
          </div>
        </section>
      </div>

      <!-- Slots -->
      <section class="panel">
        <div class="panelHead">
          <div>
            <h2>Select your availability: <span id="slotRoomLabel" class="roomTag"></span></h2>
            <p id="scheduleSubtitle"></p>
          </div>
          <div style="text-align:right">
            <div style="color:var(--muted); font-size:12px">Members submitted</div>
            <div style="font-weight:900; font-size:20px" id="memberCount">0</div>
          </div>
        </div>

        <div class="daySwitch">
          <div class="dayRow">
            <div class="dayTabs" id="dayTabs"></div>
            <button id="commentsToggle" class="dayTab commentsToggle" type="button" aria-pressed="false">Comments</button>
          </div>
          <select id="daySelect" class="daySelect" aria-label="Select day"></select>
          <div id="hiddenDaysHint" class="hint dayHint" style="display:none"></div>
        </div>

        <div id="timeModeNote" class="timeModeNote"></div>

        <div id="commentsPanel" class="commentsPanel" style="display:none">
          <label for="commentsInput">Comments for this room</label>
          <textarea id="commentsInput" placeholder="Add notes or scheduling constraints..."></textarea>
        </div>

        <div class="slotGrid" id="slotGrid"></div>

        <div class="legend">
          <div class="key">
            <div class="keyItem"><span class="swatch swSel"></span> Selected by you</div>
            <div class="keyItem"><span class="swatch swCom"></span> Selected by everyone</div>
          </div>
          <div class="keyItem" style="gap:10px">
            <span style="color:var(--muted)">Showing times in:</span>
            <button id="toggleLocal" type="button" style="padding:9px 10px">Your local time</button>
          </div>
        </div>

        <div class="topSlots" id="topSlots">
          <div class="topSlotsHeader">
            <div class="topSlotsHead">
              <div class="topSlotsTitle" id="topSlotsTitle">Availability heatmap</div>
              <div class="topSlotsSub" id="heatmapSubtitle"></div>
            </div>
            <div class="topToggle" role="tablist" aria-label="Ranking view">
              <button id="topGraphBtn" class="active" type="button" aria-pressed="true">Graph</button>
              <button id="topRankBtn" type="button" aria-pressed="false">Ranking</button>
            </div>
          </div>
          <div class="topSlotsList" id="topSlotsList"></div>
          <div class="topSlotsGraph" id="topSlotsGraph" style="display:none"></div>
        </div>
      </section>
    </div>

    <!-- Team list -->
    <section class="panel footerPanel">
      <div class="panelHead">
        <div>
          <h2>Current team selections <span id="roomListLabel" class="roomTag"></span></h2>
          <p>See who selected each slot and when they last updated.</p>
        </div>
          <div class="row" style="gap:10px">
            <button id="exportBtn" type="button">Export JSON</button>
            <button id="resetRoomBtn" class="btnDanger" type="button">Reset room (admin only)</button>
          </div>
      </div>

      <div class="members" id="members"></div>
    </section>

    <div class="hint footnote authDebugFoot" id="authDebug" style="display:none"></div>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite">
    <span id="toastMsg"></span>
  </div>
  <div class="cursorHint" id="cursorHint">Sign in to select slots.</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signInWithPopup, GoogleAuthProvider, signOut, sendSignInLinkToEmail, isSignInWithEmailLink, signInWithEmailLink } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getFirestore, doc, setDoc, collection, onSnapshot, serverTimestamp, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD7cfuYuOYIUoLavGJlfua4UYfawDcZMT0",
      authDomain: "team-scheduler-7ddab.firebaseapp.com",
      projectId: "team-scheduler-7ddab",
      storageBucket: "team-scheduler-7ddab.firebasestorage.app",
      messagingSenderId: "986652351844",
      appId: "1:986652351844:web:09874d46b6e10b4572ae71",
      measurementId: "G-72MHNL8GFY"
    };

    const THEME_KEY = "teamScheduler_theme";
    const EMAIL_LINK_KEY = "teamScheduler_emailLink";

    // 30-minute slots starting in preferred time zone, 9:00..16:00 inclusive
    const SLOT_START_MINUTE = 9 * 60;
    const SLOT_END_MINUTE = 16 * 60;
    const SLOT_INTERVAL_MINUTES = 30;
    const SLOT_START_MINUTES = Array.from(
      {length: Math.floor((SLOT_END_MINUTE - SLOT_START_MINUTE) / SLOT_INTERVAL_MINUTES) + 1},
      (_, i) => SLOT_START_MINUTE + (i * SLOT_INTERVAL_MINUTES)
    );
    const DAY_OPTIONS = [
      { id: "mon", short: "Mon", long: "Monday" },
      { id: "tue", short: "Tue", long: "Tuesday" },
      { id: "wed", short: "Wed", long: "Wednesday" },
      { id: "thu", short: "Thu", long: "Thursday" },
      { id: "fri", short: "Fri", long: "Friday" },
      { id: "sat", short: "Sat", long: "Saturday" },
      { id: "sun", short: "Sun", long: "Sunday" }
    ];
    const DEFAULT_ROOM_DAYS = ["mon", "tue", "wed", "thu", "fri"];
    const REF_DATE = { year: 2026, month: 5, day: 1 }; // stable conversion date
    const ET_TIMEZONE = "America/New_York";
    const SCHEDULE_CLOSE_ET = makeZonedDate(2026, 5, 15, 23, 59, ET_TIMEZONE, 59);
    const DAY_LOOKUP = new Map(DAY_OPTIONS.map(d => [d.id, d]));
    const DAY_ORDER = new Map(DAY_OPTIONS.map((d, i) => [d.id, i]));
    const SLOT_TIME_SET = new Set(SLOT_START_MINUTES.map(minutes => slotKeyFromMinutes(minutes)));

    const elRoom = document.getElementById("room");
    const elName = document.getElementById("name");
    const elSlotGrid = document.getElementById("slotGrid");
    const elRoomDays = document.getElementById("roomDays");
    const elRoomTzSelect = document.getElementById("roomTzSelect");
    const elRoomDateStart = document.getElementById("roomDateStart");
    const elRoomDateEnd = document.getElementById("roomDateEnd");
    const elRoomMeetingMinutes = document.getElementById("roomMeetingMinutes");
    const elDayTabs = document.getElementById("dayTabs");
    const elDaySelect = document.getElementById("daySelect");
    const elHiddenDaysHint = document.getElementById("hiddenDaysHint");
    const elCommentsToggle = document.getElementById("commentsToggle");
    const elCommentsPanel = document.getElementById("commentsPanel");
    const elCommentsInput = document.getElementById("commentsInput");
    const elTimeModeNote = document.getElementById("timeModeNote");
    const elMembers = document.getElementById("members");
    const elMemberCount = document.getElementById("memberCount");
    const elSlotRoomLabel = document.getElementById("slotRoomLabel");
    const elRoomListLabel = document.getElementById("roomListLabel");
    const elTopSlots = document.getElementById("topSlots");
    const elTopSlotsTitle = document.getElementById("topSlotsTitle");
    const elTopSlotsList = document.getElementById("topSlotsList");
    const elTopSlotsGraph = document.getElementById("topSlotsGraph");
    const elHeatmapSubtitle = document.getElementById("heatmapSubtitle");
    const elTopRankBtn = document.getElementById("topRankBtn");
    const elTopGraphBtn = document.getElementById("topGraphBtn");
    const elScheduleSubtitle = document.getElementById("scheduleSubtitle");
    const elTzPill = document.getElementById("tzPill");
    const elRoomStatusDot = document.getElementById("roomStatusDot");
    const elRoomStatusLabel = document.getElementById("roomStatusLabel");
    const elRoomStatusMeta = document.getElementById("roomStatusMeta");
    const elRoomToggleBtn = document.getElementById("roomToggleBtn");

    const elSaveBtn = document.getElementById("saveBtn");
    const elClearMeBtn = document.getElementById("clearMeBtn");
    const elExportBtn = document.getElementById("exportBtn");
    const elResetRoomBtn = document.getElementById("resetRoomBtn");
    const elToggleLocal = document.getElementById("toggleLocal");
    const elThemeBtn = document.getElementById("themeBtn");
    const elLoadRoomBtn = document.getElementById("loadRoomBtn");
    const elAuthEmail = document.getElementById("authEmail");
    const elAuthPassword = document.getElementById("authPassword");
    const elSignInBtn = document.getElementById("signInBtn");
    const elSignUpBtn = document.getElementById("signUpBtn");
    const elEmailLinkBtn = document.getElementById("emailLinkBtn");
    const elGoogleBtn = document.getElementById("googleBtn");
    const elSignOutBtn = document.getElementById("signOutBtn");
    const elAuthStatus = document.getElementById("authStatus");
    const elAuthControls = document.getElementById("authControls");
    const elAuthFields = document.getElementById("authFields");
    const elAuthEmailField = document.getElementById("authEmailField");
    const elAuthPasswordField = document.getElementById("authPasswordField");
    const elAuthSubmitBtn = document.getElementById("authSubmitBtn");
    const elAuthHint = document.getElementById("authHint");
    const elAuthProfile = document.getElementById("authProfile");
    const elAuthDebug = document.getElementById("authDebug");
    const elTzSelect = document.getElementById("tzSelect");
    const elTzResetBtn = document.getElementById("tzResetBtn");

    const elToast = document.getElementById("toast");
    const elToastMsg = document.getElementById("toastMsg");
    const elCursorHint = document.getElementById("cursorHint");

    const deviceTz = Intl.DateTimeFormat().resolvedOptions().timeZone || "UTC";
    let userTz = deviceTz;

    let showLocal = true;
    let userSelections = new Set();
    let activeRoom = "";
    let roomMembers = {};
    let roomDays = DEFAULT_ROOM_DAYS.slice();
    let roomDaysSet = new Set(roomDays);
    let activeDay = roomDays[0] || "";
    let roomOpen = true;
    let roomStatusUpdatedAt = null;
    let roomStatusByName = "";
    let roomStatusByEmail = "";
    let roomPreferredTz = ET_TIMEZONE;
    let roomDateStart = "";
    let roomDateEnd = "";
    let roomMeetingMinutes = 60;
    let showComments = false;
    let commentSaveTimer = null;
    let topView = "graph";
    let roomAdmins = [];
    let isAdmin = false;
    let roomUnsub = null;
    let roomDocUnsub = null;
    let roomConfigSeeded = false;
    let roomDaysSaveTimer = null;
    let scheduleClosed = false;
    let app = null;
    let auth = null;
    let authUser = null;
    let authMode = "";
    let db = null;
    let roomDebounce = null;
    updateTzPill();

    // ---------- Theme ----------
    function applyTheme(theme){
      if(theme === "dark") document.documentElement.setAttribute("data-theme","dark");
      else document.documentElement.removeAttribute("data-theme");
      localStorage.setItem(THEME_KEY, theme);
    }

    function toggleTheme(){
      const isDark = document.documentElement.getAttribute("data-theme") === "dark";
      applyTheme(isDark ? "light" : "dark");
      toast(isDark ? "Light theme" : "Dark theme");
    }

    function initTheme(){
      const saved = localStorage.getItem(THEME_KEY);
      if(saved === "dark" || saved === "light") applyTheme(saved);
      else {
        const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
        applyTheme(prefersDark ? "dark" : "light");
      }
    }

    // ---------- Time zone ----------
    function updateTzPill(){
      if(!elTzPill) return;
      const note = authUser ? "change below if needed" : "sign in to change";
      elTzPill.textContent = `Your time zone: ${userTz} (${note})`;
    }

    function isValidTimeZone(tz){
      if(!tz) return false;
      try{
        Intl.DateTimeFormat("en-US", { timeZone: tz }).format();
        return true;
      }catch{
        return false;
      }
    }

    function safeTimeZone(tz){
      if(isValidTimeZone(tz)) return tz;
      if(isValidTimeZone(deviceTz)) return deviceTz;
      return "UTC";
    }

    function setSelectValue(selectEl, value){
      if(!selectEl) return;
      const next = value || "";
      if(!next){
        selectEl.value = "";
        return;
      }
      const existing = Array.from(selectEl.options).some(opt => opt.value === next);
      if(!existing){
        const opt = document.createElement("option");
        opt.value = next;
        opt.textContent = timeZoneOptionLabel(next);
        selectEl.prepend(opt);
      }
      selectEl.value = next;
    }

    function formatOffsetLabel(offsetMinutes){
      const sign = offsetMinutes >= 0 ? "+" : "-";
      const abs = Math.abs(offsetMinutes);
      const hours = Math.floor(abs / 60);
      const minutes = abs % 60;
      return `GMT${sign}${pad2(hours)}:${pad2(minutes)}`;
    }

    function timeZoneOptionLabel(timeZone){
      try{
        const offsetMinutes = Math.round(tzOffsetMs(new Date(), timeZone) / 60000);
        return `${formatOffsetLabel(offsetMinutes)} | ${timeZone}`;
      }catch{
        return timeZone;
      }
    }

    function formatMemberTimeZone(tz){
      if(!tz) return "";
      if(!isValidTimeZone(tz)) return tz;
      return timeZoneOptionLabel(tz);
    }

    function populateTimeZoneSelect(selectEl, currentTz){
      if(!selectEl) return;
      let zones = [];
      if(typeof Intl.supportedValuesOf === "function"){
        zones = Intl.supportedValuesOf("timeZone");
      }
      if(!zones.length){
        selectEl.innerHTML = `<option value="${currentTz}">${timeZoneOptionLabel(currentTz)}</option>`;
        selectEl.value = currentTz;
        return;
      }
      const now = new Date();
      const sorted = zones
        .map((zone) => ({
          zone,
          offset: Math.round(tzOffsetMs(now, zone) / 60000)
        }))
        .sort((a, b) => {
          if(a.offset !== b.offset) return a.offset - b.offset;
          return a.zone.localeCompare(b.zone);
        });
      selectEl.innerHTML = sorted.map(({ zone }) =>
        `<option value="${zone}">${timeZoneOptionLabel(zone)}</option>`
      ).join("");
      setSelectValue(selectEl, currentTz);
    }

    function setUserTimeZone(nextTz, { save = true, showToast = true } = {}){
      const trimmed = String(nextTz || "").trim();
      const candidate = trimmed || deviceTz;
      if(!isValidTimeZone(candidate)){
        if(showToast) toast("Enter a valid IANA time zone.");
        return false;
      }
      if(candidate === userTz) return true;
      userTz = candidate;
      if(elTzSelect) setSelectValue(elTzSelect, candidate);
      updateTzPill();
      updateToggleLabel();
      renderSlots();
      renderMembers();
      if(save) autoSaveIfIdentified();
      return true;
    }

    function initTimeZoneOptions(){
      populateTimeZoneSelect(elTzSelect, userTz);
      populateTimeZoneSelect(elRoomTzSelect, roomPreferredTz);
    }

    function commitTimeZoneSelect(){
      if(!authUser) return toast("Sign in to change time zone.");
      if(!elTzSelect) return;
      const ok = setUserTimeZone(elTzSelect.value, { save: true, showToast: true });
      if(!ok) elTzSelect.value = userTz;
    }

    // ---------- Toast ----------
    function toast(msg){
      elToastMsg.textContent = msg;
      elToast.classList.add("show");
      clearTimeout(toast._t);
      toast._t = setTimeout(()=> elToast.classList.remove("show"), 1800);
    }

    function shouldShowSignInHint(){
      return !authUser && !scheduleClosed && roomOpen;
    }

    function showCursorHint(x, y){
      if(!elCursorHint) return;
      elCursorHint.textContent = "Sign in to select slots.";
      const padding = 16;
      const rect = elCursorHint.getBoundingClientRect();
      let left = x + 12;
      let top = y + 12;
      if(left + rect.width + padding > window.innerWidth){
        left = Math.max(padding, window.innerWidth - rect.width - padding);
      }
      if(top + rect.height + padding > window.innerHeight){
        top = Math.max(padding, window.innerHeight - rect.height - padding);
      }
      elCursorHint.style.left = `${left}px`;
      elCursorHint.style.top = `${top}px`;
      elCursorHint.classList.add("show");
    }

    function hideCursorHint(){
      if(!elCursorHint) return;
      elCursorHint.classList.remove("show");
    }

    function loadRoomFromInput(){
      const rk = roomKey();
      if(!rk) return toast("Enter a room code first.");
      elRoom.value = rk;
      onRoomCommit();
      toast(`Room "${rk}" loaded.`);
    }

    // ---------- Firebase ----------
    function initFirebase(){
      try{
        if(!firebaseConfig || !firebaseConfig.apiKey) throw new Error("Missing Firebase config");
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        initAuth();
      }catch(err){
        console.warn("Firebase init failed. Paste your config in index.html.", err);
      }
    }

    function ensureDb(showToast=true){
      if(db) return true;
      if(showToast) toast("Add Firebase config first.");
      return false;
    }

    function ensureAuth(showToast=true){
      if(authUser) return true;
      if(showToast) toast("Sign in to access this room.");
      return false;
    }

    function initAuth(){
      if(!auth) return;
      onAuthStateChanged(auth, (user) => {
        authUser = user || null;
        updateAuthUI();

        if(authUser && authUser.displayName && !elName.value.trim()){
          elName.value = authUser.displayName;
        }

        if(!authUser && roomUnsub){
          roomUnsub();
          roomUnsub = null;
        }
        if(!authUser && roomDocUnsub){
          roomDocUnsub();
          roomDocUnsub = null;
        }

      if(!authUser){
        roomMembers = {};
        userSelections = new Set();
        roomDays = DEFAULT_ROOM_DAYS.slice();
        roomDaysSet = new Set(roomDays);
        activeDay = roomDays[0] || "";
        roomOpen = true;
        roomStatusUpdatedAt = null;
        roomStatusByName = "";
        roomStatusByEmail = "";
        roomAdmins = [];
        isAdmin = false;
        setUserTimeZone(deviceTz, { save: false, showToast: false });
        if(elCommentsInput) elCommentsInput.value = "";
      }

        setRoomFromInput();
        updateActionState();
        renderAll();
      });
    }

    function updateAuthUI(){
      if(authUser){
        elAuthStatus.textContent = `Signed in as ${authUser.email || "user"}`;
        if(authUser.email) elAuthEmail.value = authUser.email;
        elAuthPassword.value = "";
        elAuthControls.style.display = "none";
        elSignOutBtn.style.display = "inline-flex";
        elAuthProfile.style.display = "block";
        elName.disabled = false;
        if(elTzSelect){
          elTzSelect.disabled = false;
          elTzSelect.value = userTz;
        }
        if(elTzResetBtn) elTzResetBtn.disabled = false;
      }else{
        elAuthStatus.textContent = "Not signed in";
        elAuthControls.style.display = "block";
        elSignOutBtn.style.display = "none";
        elAuthProfile.style.display = "none";
        elName.disabled = true;
        if(elTzSelect){
          elTzSelect.disabled = true;
          elTzSelect.value = userTz;
        }
        if(elTzResetBtn) elTzResetBtn.disabled = true;
        setAuthMode("");
      }
      updateAuthDebug();
      updateAdminState();
      updateTzPill();
    }

    function updateAuthDebug(){
      if(!elAuthDebug) return;
      if(authUser){
        const provider = authUser.providerData && authUser.providerData.length
          ? authUser.providerData[0].providerId
          : "unknown";
        const uid = authUser.uid || "unknown";
        const email = authUser.email || "unknown";
        const verified = authUser.emailVerified ? "yes" : "no";
        elAuthDebug.textContent = `Auth ok: ${email} | Provider: ${provider} | UID: ${uid} | Verified: ${verified}`;
      }else{
        elAuthDebug.textContent = "Auth: signed out (no Firebase user).";
      }
      elAuthDebug.style.display = "block";
    }

    function setAuthMode(mode){
      authMode = mode || "";
      const hasMode = !!authMode;
      const showEmail = authMode === "signin" || authMode === "signup" || authMode === "emaillink";
      const showPassword = authMode === "signin" || authMode === "signup";

      elAuthFields.classList.toggle("active", hasMode);
      elAuthEmailField.style.display = showEmail ? "block" : "none";
      elAuthPasswordField.style.display = showPassword ? "block" : "none";
      elAuthSubmitBtn.style.display = hasMode ? "inline-flex" : "none";

      const labelMap = {
        signin: "Sign in",
        signup: "Create account",
        emaillink: "Send email link"
      };
      elAuthSubmitBtn.textContent = labelMap[authMode] || "Continue";
      elAuthHint.textContent = authMode === "emaillink"
        ? "We will email you a sign-in link."
        : "";

      elSignInBtn.setAttribute("aria-expanded", authMode === "signin" ? "true" : "false");
      elSignUpBtn.setAttribute("aria-expanded", authMode === "signup" ? "true" : "false");
      elEmailLinkBtn.setAttribute("aria-expanded", authMode === "emaillink" ? "true" : "false");
      elSignInBtn.classList.toggle("active", authMode === "signin");
      elSignUpBtn.classList.toggle("active", authMode === "signup");
      elEmailLinkBtn.classList.toggle("active", authMode === "emaillink");

      if(showEmail) elAuthEmail.focus();
    }

    function submitAuth(){
      if(authMode === "signin") return void signInEmail();
      if(authMode === "signup") return void signUpEmail();
      if(authMode === "emaillink") return void sendEmailLink();
    }

    function authErrorMessage(err){
      const code = err && err.code ? err.code : "";
      const map = {
        "auth/invalid-email": "Enter a valid email address.",
        "auth/user-not-found": "No account found. Use Create account.",
        "auth/wrong-password": "Incorrect password.",
        "auth/email-already-in-use": "Email already in use. Try Sign in.",
        "auth/weak-password": "Password should be at least 6 characters.",
        "auth/popup-closed-by-user": "Popup closed.",
        "auth/unauthorized-domain": "Add this domain to Firebase Auth settings.",
        "auth/account-exists-with-different-credential": "Account exists with a different sign-in method.",
        "auth/operation-not-allowed": "Enable this sign-in method in Firebase Auth.",
        "auth/invalid-action-code": "Invalid or expired email link.",
        "auth/expired-action-code": "Email link expired. Request a new one.",
        "auth/invalid-continue-uri": "Invalid sign-in link URL. Check authorized domains."
      };
      return map[code] || "Authentication failed.";
    }

    async function signInEmail(){
      if(!auth) return toast("Add Firebase config first.");
      const email = elAuthEmail.value.trim();
      const password = elAuthPassword.value;
      if(!email || !password) return toast("Enter email and password.");
      try{
        await signInWithEmailAndPassword(auth, email, password);
        elAuthPassword.value = "";
        toast("Signed in.");
      }catch(err){
        toast(authErrorMessage(err));
      }
    }

    async function signUpEmail(){
      if(!auth) return toast("Add Firebase config first.");
      const email = elAuthEmail.value.trim();
      const password = elAuthPassword.value;
      if(!email || !password) return toast("Enter email and password.");
      try{
        await createUserWithEmailAndPassword(auth, email, password);
        elAuthPassword.value = "";
        toast("Account created.");
      }catch(err){
        toast(authErrorMessage(err));
      }
    }

    function getActionUrl(){
      if(window.location.protocol === "file:" || window.location.origin === "null") return "";
      return `${window.location.origin}${window.location.pathname}`;
    }

    async function sendEmailLink(){
      if(!auth) return toast("Add Firebase config first.");
      const email = elAuthEmail.value.trim();
      if(!email) return toast("Enter your email first.");

      const actionUrl = getActionUrl();
      if(!actionUrl) return toast("Email link requires a hosted URL (not file://).");

      try{
        await sendSignInLinkToEmail(auth, email, {
          url: actionUrl,
          handleCodeInApp: true
        });
        localStorage.setItem(EMAIL_LINK_KEY, email);
        toast("Email link sent. Check your inbox.");
      }catch(err){
        toast(authErrorMessage(err));
      }
    }

    async function handleEmailLinkSignIn(){
      if(!auth || !isSignInWithEmailLink(auth, window.location.href)) return;
      let email = localStorage.getItem(EMAIL_LINK_KEY) || elAuthEmail.value.trim();
      if(!email){
        email = window.prompt("Confirm your email to finish sign-in") || "";
      }
      if(!email) return toast("Email required to finish sign-in.");

      try{
        await signInWithEmailLink(auth, email, window.location.href);
        localStorage.removeItem(EMAIL_LINK_KEY);
        toast("Signed in.");
        if(window.history && window.history.replaceState){
          const cleanUrl = `${window.location.origin}${window.location.pathname}`;
          window.history.replaceState({}, document.title, cleanUrl);
        }
      }catch(err){
        toast(authErrorMessage(err));
      }
    }

    async function signInGoogle(){
      if(!auth) return toast("Add Firebase config first.");
      try{
        const provider = new GoogleAuthProvider();
        await signInWithPopup(auth, provider);
        toast("Signed in.");
      }catch(err){
        toast(authErrorMessage(err));
      }
    }

    async function signOutUser(){
      if(!auth) return;
      try{
        await signOut(auth);
        toast("Signed out.");
      }catch(err){
        toast(authErrorMessage(err));
      }
    }

    // ---------- Room handling ----------
    function normalizeRoom(room){
      return String(room || "")
        .trim()
        .toLowerCase()
        .replace(/\s+/g, "-")
        .replace(/[^a-z0-9-_]/g, "");
    }

    function roomKey(){
      return normalizeRoom(elRoom.value);
    }

    function normalizeRoomDays(days){
      const set = new Set((days || []).map(d => String(d).toLowerCase()));
      const ordered = DAY_OPTIONS.filter(d => set.has(d.id)).map(d => d.id);
      return ordered.length ? ordered : DEFAULT_ROOM_DAYS.slice();
    }

    function normalizeMeetingMinutes(value){
      const num = Number(value);
      if(!Number.isFinite(num)) return null;
      const rounded = Math.round(num);
      return rounded > 0 ? rounded : null;
    }

    function dayLabelShort(dayId){
      return DAY_LOOKUP.get(dayId)?.short || dayId;
    }

    function dayLabelLong(dayId){
      return DAY_LOOKUP.get(dayId)?.long || dayId;
    }

    function slotKey(dayId, minutes){
      return `${dayId}-${slotKeyFromMinutes(minutes)}`;
    }

    function parseSlotKey(slotKey){
      const raw = String(slotKey || "");
      const parts = raw.split("-", 2);
      if(parts.length < 2) return { dayId: "", time: raw };
      return { dayId: parts[0], time: parts[1] };
    }

    function isAllowedSlot(slotKey){
      const { dayId, time } = parseSlotKey(slotKey);
      return roomDaysSet.has(dayId) && SLOT_TIME_SET.has(time);
    }

    function isKnownSlot(slotKey){
      const { dayId, time } = parseSlotKey(slotKey);
      return DAY_LOOKUP.has(dayId) && SLOT_TIME_SET.has(time);
    }

    function filterSlots(slots){
      if(!Array.isArray(slots)) return [];
      return slots.filter(isAllowedSlot);
    }

    function normalizeUserSelections(slots){
      if(!Array.isArray(slots)) return [];
      return slots.filter(isKnownSlot);
    }

    function slotSortValue(slotKey){
      const { dayId, time } = parseSlotKey(slotKey);
      const dayIndex = DAY_ORDER.has(dayId) ? DAY_ORDER.get(dayId) : 99;
      const minutes = parseTimeString(time);
      return (dayIndex * 1440) + (Number.isFinite(minutes) ? minutes : 0);
    }

    function applyRoomDays(days){
      roomDays = normalizeRoomDays(days);
      roomDaysSet = new Set(roomDays);
      if(!roomDaysSet.has(activeDay)) activeDay = roomDays[0] || "";
      renderDayControls();
      updateHiddenDaysHint();
    }

    function updateRoomLabel(){
      if(!elSlotRoomLabel) return;
      const rk = activeRoom || "";
      elSlotRoomLabel.textContent = rk;
      if(elRoomListLabel) elRoomListLabel.textContent = rk ? `(${rk})` : "";
    }

    function updateScheduleSubtitle(){
      if(!elScheduleSubtitle) return;
      if(!activeRoom || !authUser){
        elScheduleSubtitle.textContent = "";
        return;
      }
      const range = formatDateRange(roomDateStart, roomDateEnd, roomPreferredTz);
      elScheduleSubtitle.textContent = range
        ? `Scheduled period: ${range}`
        : "Scheduled period: not set.";
    }

    function updateTimeModeNote(){
      if(!elTimeModeNote) return;
      elTimeModeNote.textContent = showLocal
        ? "Currently showing local time in bold."
        : "Currently showing room's default time in bold.";
    }

    function setCommentsView(show){
      showComments = !!show;
      if(elCommentsToggle){
        elCommentsToggle.classList.toggle("active", showComments);
        elCommentsToggle.setAttribute("aria-pressed", showComments ? "true" : "false");
      }
      if(elCommentsPanel) elCommentsPanel.style.display = showComments ? "block" : "none";
      if(elSlotGrid) elSlotGrid.style.display = showComments ? "none" : "";
    }

    function updateCommentsUI(){
      const disabled = isInteractionLocked() || !activeRoom || !db;
      if(elCommentsInput){
        elCommentsInput.disabled = disabled;
        elCommentsInput.setAttribute("aria-disabled", disabled ? "true" : "false");
      }
      if(elCommentsToggle){
        elCommentsToggle.disabled = disabled;
        elCommentsToggle.classList.toggle("isDisabled", disabled);
        elCommentsToggle.setAttribute("aria-disabled", disabled ? "true" : "false");
        if(disabled && showComments) setCommentsView(false);
      }
    }

    function updateToggleLabel(){
      if(!elToggleLocal) return;
      const localAbbr = timeZoneAbbr(new Date(), safeTimeZone(userTz));
      const preferredAbbr = timeZoneAbbr(new Date(), safeTimeZone(roomPreferredTz));
      const localSuffix = localAbbr ? ` (${localAbbr})` : "";
      const preferredSuffix = preferredAbbr ? ` (${preferredAbbr})` : "";
      elToggleLocal.textContent = showLocal
        ? `Your local time${localSuffix}`
        : `Room's time zone${preferredSuffix}`;
    }

    function updateTopViewUI(){
      if(elTopRankBtn){
        elTopRankBtn.classList.toggle("active", topView === "rank");
        elTopRankBtn.setAttribute("aria-pressed", topView === "rank" ? "true" : "false");
      }
      if(elTopGraphBtn){
        elTopGraphBtn.classList.toggle("active", topView === "graph");
        elTopGraphBtn.setAttribute("aria-pressed", topView === "graph" ? "true" : "false");
      }
      if(elTopSlotsTitle){
        elTopSlotsTitle.textContent = topView === "graph"
          ? "Availability heatmap"
          : "Top 7 most chosen slots";
      }
      if(elTopSlotsList) elTopSlotsList.style.display = topView === "rank" ? "grid" : "none";
      if(elTopSlotsGraph) elTopSlotsGraph.style.display = topView === "graph" ? "block" : "none";
      updateHeatmapSubtitle();
    }

    function setTopView(view){
      topView = view === "graph" ? "graph" : "rank";
      updateTopViewUI();
      renderSlots();
    }

    function updateHeatmapSubtitle(){
      if(!elHeatmapSubtitle) return;
      if(topView !== "graph"){
        elHeatmapSubtitle.textContent = "";
        return;
      }
      const zone = safeTimeZone(showLocal ? userTz : roomPreferredTz);
      const abbr = timeZoneAbbr(new Date(), zone);
      const label = abbr ? abbr : zone;
      const mode = showLocal ? "your local time" : "room's default time";
      elHeatmapSubtitle.textContent = `Times shown in ${mode} (${label}).`;
    }

    function canEditRoomSettings(){
      return !!authUser && !!activeRoom && !!db && roomOpen;
    }

    function updateRoomSettingsUI(){
      const canEdit = canEditRoomSettings();
      if(elRoomTzSelect){
        setSelectValue(elRoomTzSelect, roomPreferredTz);
        elRoomTzSelect.disabled = !canEdit;
        elRoomTzSelect.setAttribute("aria-disabled", canEdit ? "false" : "true");
      }
      if(elRoomDateStart){
        elRoomDateStart.value = roomDateStart || "";
        elRoomDateStart.disabled = !canEdit;
        elRoomDateStart.setAttribute("aria-disabled", canEdit ? "false" : "true");
      }
      if(elRoomDateEnd){
        elRoomDateEnd.value = roomDateEnd || "";
        elRoomDateEnd.disabled = !canEdit;
        elRoomDateEnd.setAttribute("aria-disabled", canEdit ? "false" : "true");
      }
      if(elRoomMeetingMinutes){
        elRoomMeetingMinutes.value = roomMeetingMinutes ? String(roomMeetingMinutes) : "";
        elRoomMeetingMinutes.disabled = !canEdit;
        elRoomMeetingMinutes.setAttribute("aria-disabled", canEdit ? "false" : "true");
      }
    }

    function updateHiddenDaysHint(){
      if(!elHiddenDaysHint) return;
      const hidden = new Set();
      for(const s of userSelections){
        if(!isKnownSlot(s)) continue;
        const parsed = parseSlotKey(s);
        if(parsed.dayId && !roomDaysSet.has(parsed.dayId)){
          hidden.add(parsed.dayId);
        }
      }

      if(hidden.size === 0){
        elHiddenDaysHint.style.display = "none";
        elHiddenDaysHint.textContent = "";
        return;
      }

      const labels = Array.from(hidden)
        .sort((a,b) => (DAY_ORDER.get(a) ?? 99) - (DAY_ORDER.get(b) ?? 99))
        .map(dayLabelShort)
        .join(", ");
      elHiddenDaysHint.textContent = `Hidden selections on: ${labels}`;
      elHiddenDaysHint.style.display = "block";
    }

    function setRoomFromInput(){
      const normalized = roomKey();
      if(normalized !== elRoom.value) elRoom.value = normalized;
      const needsResubscribe = normalized !== activeRoom || !roomUnsub || !roomDocUnsub;
      if(!needsResubscribe) return;

      activeRoom = normalized;
      roomConfigSeeded = false;
      updateRoomLabel();

      if(roomUnsub){
        roomUnsub();
        roomUnsub = null;
      }
      if(roomDocUnsub){
        roomDocUnsub();
        roomDocUnsub = null;
      }

          roomMembers = {};
          userSelections = new Set();
          roomDays = DEFAULT_ROOM_DAYS.slice();
          roomDaysSet = new Set(roomDays);
          activeDay = roomDays[0] || "";
          roomOpen = true;
          roomStatusUpdatedAt = null;
          roomStatusByName = "";
          roomStatusByEmail = "";
          roomPreferredTz = ET_TIMEZONE;
          const defaultDates = getDefaultRoomDates(roomPreferredTz);
          roomDateStart = defaultDates.start;
          roomDateEnd = defaultDates.end;
          roomMeetingMinutes = 60;
          roomAdmins = [];
          isAdmin = false;
          setCommentsView(false);
          renderAll();

      if(!activeRoom) return;
      if(!ensureDb(false) || !ensureAuth(false)) return;

      roomDocUnsub = onSnapshot(
        doc(db, "rooms", activeRoom),
        (docSnap) => {
          const data = docSnap.data() || {};
          const seedPayload = {};
          if(Array.isArray(data.days)){
            applyRoomDays(data.days);
          }else{
            applyRoomDays(DEFAULT_ROOM_DAYS);
            seedPayload.days = DEFAULT_ROOM_DAYS;
          }

          const preferredTz = isValidTimeZone(data.preferredTz) ? data.preferredTz : ET_TIMEZONE;
          roomPreferredTz = preferredTz;

          const hasStart = !!parseDateKey(data.dateStart);
          const hasEnd = !!parseDateKey(data.dateEnd);
          const normalizedDates = normalizeRoomDateRange(data.dateStart, data.dateEnd, roomPreferredTz);
          roomDateStart = normalizedDates.start;
          roomDateEnd = normalizedDates.end;

          if(!isValidTimeZone(data.preferredTz)) seedPayload.preferredTz = roomPreferredTz;
          if(!hasStart) seedPayload.dateStart = roomDateStart;
          if(!hasEnd) seedPayload.dateEnd = roomDateEnd;

          const meetingMinutes = normalizeMeetingMinutes(data.meetingMinutes);
          roomMeetingMinutes = meetingMinutes || 60;
          if(!meetingMinutes) seedPayload.meetingMinutes = roomMeetingMinutes;

          if(Object.keys(seedPayload).length && !roomConfigSeeded){
            roomConfigSeeded = true;
            seedPayload.updatedAt = serverTimestamp();
            void setDoc(doc(db, "rooms", activeRoom), seedPayload, { merge: true });
          }

          roomOpen = typeof data.isOpen === "boolean" ? data.isOpen : true;
          roomStatusUpdatedAt = data.statusUpdatedAt && typeof data.statusUpdatedAt.toDate === "function"
            ? data.statusUpdatedAt.toDate()
            : null;
          roomStatusByName = typeof data.statusByName === "string" ? data.statusByName : "";
          roomStatusByEmail = typeof data.statusByEmail === "string" ? data.statusByEmail : "";
          roomAdmins = Array.isArray(data.admins)
            ? data.admins.map(email => String(email).toLowerCase())
            : [];
          updateAdminState();
          renderAll();
        },
        (err) => {
          console.error(err);
          toast("Unable to load room settings.");
        }
      );

      roomUnsub = onSnapshot(
        collection(db, "rooms", activeRoom, "members"),
        (snapshot) => {
          const nextMembers = {};
          snapshot.forEach((docSnap) => {
            const data = docSnap.data() || {};
            const emailLower = String(data.email || docSnap.id || "").toLowerCase();
            const updatedAt = data.updatedAt && typeof data.updatedAt.toDate === "function"
              ? data.updatedAt.toDate()
              : null;

            nextMembers[emailLower] = {
              name: data.name || "",
              email: emailLower,
              tz: data.tz || "",
              slots: Array.isArray(data.slots) ? data.slots : [],
              comments: typeof data.comments === "string" ? data.comments : "",
              updatedAt
            };
          });

          roomMembers = nextMembers;
          syncFromSnapshot();
          renderAll();
        },
        (err) => {
          console.error(err);
          toast("Unable to load room data.");
        }
      );
    }

    function ensureActiveRoom(){
      const rk = roomKey();
      if(!rk) return "";
      if(rk !== activeRoom) setRoomFromInput();
      return rk;
    }

    function getUserEmail(){
      if(authUser && authUser.email) return authUser.email.toLowerCase();
      return "";
    }

    function isValidEmail(email){
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email.trim());
    }

    // ---------- Time labels ----------
    function pad2(n){ return String(n).padStart(2,"0"); }
    function slotKeyFromMinutes(totalMinutes){
      const hours = Math.floor(totalMinutes / 60);
      const minutes = totalMinutes % 60;
      return `${pad2(hours)}:${pad2(minutes)}`;
    }

    function parseTimeString(timeStr){
      const match = /^(\d{2}):(\d{2})$/.exec(String(timeStr || ""));
      if(!match) return null;
      const hours = Number(match[1]);
      const minutes = Number(match[2]);
      if(!Number.isFinite(hours) || !Number.isFinite(minutes)) return null;
      return (hours * 60) + minutes;
    }

    function parseDateKey(dateKey){
      const match = /^(\d{4})-(\d{2})-(\d{2})$/.exec(String(dateKey || ""));
      if(!match) return null;
      return { year: Number(match[1]), month: Number(match[2]), day: Number(match[3]) };
    }

    function dateKeyFromParts(year, month, day){
      if(!year || !month || !day) return "";
      return `${year}-${pad2(month)}-${pad2(day)}`;
    }

    function dateKeyInZone(date, timeZone){
      try{
        const tz = safeTimeZone(timeZone);
        const fmt = new Intl.DateTimeFormat("en-CA", {
          timeZone: tz,
          year: "numeric",
          month: "2-digit",
          day: "2-digit"
        });
        const parts = fmt.formatToParts(date);
        const get = (t) => parts.find(p => p.type === t)?.value;
        return dateKeyFromParts(Number(get("year")), Number(get("month")), Number(get("day")));
      }catch{
        return "";
      }
    }

    function addMonthsToDateKey(dateKey, months){
      const parsed = parseDateKey(dateKey);
      if(!parsed) return "";
      const d = new Date(Date.UTC(parsed.year, parsed.month - 1, parsed.day));
      d.setUTCMonth(d.getUTCMonth() + months);
      return dateKeyFromParts(d.getUTCFullYear(), d.getUTCMonth() + 1, d.getUTCDate());
    }

    function normalizeRoomDateRange(startKey, endKey, timeZone){
      let start = parseDateKey(startKey) ? String(startKey) : "";
      let end = parseDateKey(endKey) ? String(endKey) : "";
      if(!start){
        start = dateKeyInZone(new Date(), timeZone);
      }
      if(!end){
        end = addMonthsToDateKey(start, 1) || start;
      }
      if(start && end && end < start){
        end = start;
      }
      return { start, end };
    }

    function getDefaultRoomDates(timeZone){
      const start = dateKeyInZone(new Date(), timeZone);
      const end = addMonthsToDateKey(start, 1) || start;
      return { start, end };
    }

    function formatDateKey(dateKey, timeZone){
      const parsed = parseDateKey(dateKey);
      if(!parsed) return "";
      const tz = safeTimeZone(timeZone);
      const d = makeZonedDate(parsed.year, parsed.month, parsed.day, 12, 0, tz);
      return new Intl.DateTimeFormat(undefined, {
        timeZone: tz,
        month: "short",
        day: "numeric",
        year: "numeric"
      }).format(d);
    }

    function formatDateRange(startKey, endKey, timeZone){
      const startLabel = formatDateKey(startKey, timeZone);
      const endLabel = formatDateKey(endKey, timeZone);
      if(!startLabel && !endLabel) return "";
      if(startKey && endKey && startKey === endKey) return startLabel || endLabel;
      if(startLabel && endLabel) return `${startLabel} - ${endLabel}`;
      return startLabel || endLabel;
    }

    function timeZoneAbbr(date, timeZone){
      try{
        const fmt = new Intl.DateTimeFormat("en-US", { timeZone, timeZoneName: "short" });
        const part = fmt.formatToParts(date).find(p => p.type === "timeZoneName");
        return part ? part.value : "";
      }catch{
        return "";
      }
    }

    function slotBaseDate(minutes){
      const baseTz = safeTimeZone(roomPreferredTz);
      const hour = Math.floor(minutes / 60);
      const minute = minutes % 60;
      return makeZonedDate(REF_DATE.year, REF_DATE.month, REF_DATE.day, hour, minute, baseTz);
    }

    function timeOnlyInZone(minutes, timeZone){
      const d = slotBaseDate(minutes);
      const tz = safeTimeZone(timeZone);
      return new Intl.DateTimeFormat(undefined, {
        hour:"numeric", minute:"2-digit", hour12:true, timeZone: tz
      }).format(d);
    }

    function timeLabelInZone(minutes, timeZone){
      const d = slotBaseDate(minutes);
      const tz = safeTimeZone(timeZone);
      const time = new Intl.DateTimeFormat(undefined, {
        hour:"numeric", minute:"2-digit", hour12:true, timeZone: tz
      }).format(d);
      const abbr = timeZoneAbbr(d, tz);
      return abbr ? `${time} ${abbr}` : time;
    }

    function makeZonedDate(year, month, day, hour, minute, timeZone, second = 0){
      const utcGuess = new Date(Date.UTC(year, month-1, day, hour, minute, second));
      const offsetMs = tzOffsetMs(utcGuess, timeZone);
      return new Date(utcGuess.getTime() - offsetMs);
    }

    function tzOffsetMs(date, timeZone){
      const f = new Intl.DateTimeFormat("en-US", {
        timeZone,
        year: "numeric", month: "2-digit", day: "2-digit",
        hour: "2-digit", minute: "2-digit", second: "2-digit",
        hour12: false
      });
      const parts = f.formatToParts(date);
      const get = (t) => Number(parts.find(p => p.type === t).value);
      const asUTC = Date.UTC(get("year"), get("month")-1, get("day"), get("hour"), get("minute"), get("second"));
      return asUTC - date.getTime();
    }

    function isSchedulingClosed(){
      return Date.now() >= SCHEDULE_CLOSE_ET.getTime();
    }

    function isInteractionLocked(){
      return scheduleClosed || !roomOpen || !authUser;
    }

    function lockMessage(){
      if(scheduleClosed) return "Scheduling is closed.";
      if(!roomOpen) return "Room is closed.";
      if(!authUser) return "Sign in to continue.";
      return "";
    }

    function updateScheduleStatus(){
      scheduleClosed = isSchedulingClosed();
      updateActionState();
    }

    function updateActionState(){
      const disabled = isInteractionLocked();
      [elSaveBtn, elClearMeBtn].forEach((btn) => {
        btn.classList.toggle("isDisabled", disabled);
        btn.disabled = disabled;
        btn.setAttribute("aria-disabled", disabled ? "true" : "false");
      });
      hideCursorHint();
      updateRoomStatusUI();
      updateAdminUI();
      updateRoomSettingsUI();
      updateScheduleSubtitle();
      updateTimeModeNote();
      updateToggleLabel();
      updateCommentsUI();
      updateTopViewUI();
      updateHeatmapSubtitle();
      renderSlots();
    }

    function updateAdminState(){
      const email = getUserEmail();
      isAdmin = !!email && roomAdmins.includes(email);
    }

    function updateAdminUI(){
      if(!elResetRoomBtn) return;
      const canReset = !!authUser && !!activeRoom && !!db && isAdmin;
      elResetRoomBtn.disabled = !canReset;
      elResetRoomBtn.classList.toggle("isDisabled", !canReset);
      elResetRoomBtn.setAttribute("aria-disabled", canReset ? "false" : "true");
    }

    function updateRoomStatusUI(){
      if(!elRoomStatusLabel || !elRoomStatusDot || !elRoomToggleBtn || !elRoomStatusMeta) return;
      const isOpen = roomOpen !== false;
      elRoomStatusLabel.textContent = isOpen ? "Room open" : "Room closed";
      elRoomStatusDot.style.background = isOpen ? "var(--good)" : "var(--bad)";
      elRoomToggleBtn.textContent = isOpen ? "Close room" : "Open room";

      const canToggle = !!authUser && !!activeRoom && !!db;
      elRoomToggleBtn.disabled = !canToggle;
      elRoomToggleBtn.classList.toggle("isDisabled", !canToggle);
      elRoomToggleBtn.setAttribute("aria-disabled", canToggle ? "false" : "true");

      const actor = roomStatusByName && roomStatusByEmail
        ? `${roomStatusByName} (${roomStatusByEmail})`
        : (roomStatusByName || roomStatusByEmail);
      const when = roomStatusUpdatedAt ? roomStatusUpdatedAt.toLocaleString() : "";
      if(actor || when){
        const verb = isOpen ? "Opened" : "Closed";
        const who = actor ? ` by ${actor}` : "";
        const time = when ? ` on ${when}` : "";
        elRoomStatusMeta.textContent = `${verb}${who}${time}.`;
        elRoomStatusMeta.style.display = "block";
      }else{
        elRoomStatusMeta.textContent = "";
        elRoomStatusMeta.style.display = "none";
      }
    }

    function renderDayControls(){
      if(!elRoomDays || !elDayTabs || !elDaySelect) return;
      const canEdit = !!authUser && !!activeRoom && roomOpen;
      const selectedDays = new Set();
      for(const slot of userSelections){
        if(!isKnownSlot(slot)) continue;
        const parsed = parseSlotKey(slot);
        if(parsed.dayId) selectedDays.add(parsed.dayId);
      }

      elRoomDays.innerHTML = DAY_OPTIONS.map((d) => {
        const isActive = roomDaysSet.has(d.id);
        const disabledClass = canEdit ? "" : " isDisabled";
        const disabledAttr = canEdit ? "" : "disabled";
        return `
          <button type="button" class="dayChoice ${isActive ? "active" : ""}${disabledClass}" data-day="${d.id}"
            aria-pressed="${isActive}" ${disabledAttr}>
            ${d.short}
          </button>`;
      }).join("");

      elDayTabs.innerHTML = roomDays.map((dayId) => {
        const isActive = dayId === activeDay;
        const hasSelections = selectedDays.has(dayId);
        return `
          <button type="button" class="dayTab ${isActive ? "active" : ""}${hasSelections ? " hasSelections" : ""}" data-day="${dayId}"
            aria-pressed="${isActive}">
            ${dayLabelShort(dayId)}
          </button>`;
      }).join("");

      elDaySelect.innerHTML = roomDays.map((dayId) =>
        `<option value="${dayId}">${dayLabelLong(dayId)}${selectedDays.has(dayId) ? " •" : ""}</option>`
      ).join("");
      elDaySelect.value = activeDay || "";
      elDaySelect.disabled = roomDays.length === 0;
    }

    function setActiveDay(dayId){
      if(!roomDaysSet.has(dayId)) return;
      activeDay = dayId;
      renderDayControls();
      renderSlots();
    }

    function toggleRoomDay(dayId){
      if(!ensureAuth()) return;
      if(!roomOpen) return toast("Room is closed.");
      const rk = ensureActiveRoom();
      if(!rk) return toast("Enter a room code to set room days.");

      const next = new Set(roomDays);
      if(next.has(dayId)){
        if(next.size === 1) return toast("Select at least one day.");
        next.delete(dayId);
      }else{
        next.add(dayId);
      }

      const ordered = DAY_OPTIONS.filter(d => next.has(d.id)).map(d => d.id);
      applyRoomDays(ordered);
      renderAll();
      scheduleRoomDaysSave();
    }

    function setRoomPreferredTz(nextTz, { save = true, showToast = true } = {}){
      const trimmed = String(nextTz || "").trim();
      const candidate = trimmed || ET_TIMEZONE;
      if(!isValidTimeZone(candidate)){
        if(showToast) toast("Enter a valid IANA time zone.");
        return false;
      }
      if(candidate === roomPreferredTz) return true;
      roomPreferredTz = candidate;
      const normalized = normalizeRoomDateRange(roomDateStart, roomDateEnd, roomPreferredTz);
      const dateChanged = normalized.start !== roomDateStart || normalized.end !== roomDateEnd;
      roomDateStart = normalized.start;
      roomDateEnd = normalized.end;
      updateRoomSettingsUI();
      updateScheduleSubtitle();
      updateToggleLabel();
      renderSlots();
      renderMembers();
      if(save){
        const payload = { preferredTz: roomPreferredTz };
        if(dateChanged){
          payload.dateStart = roomDateStart;
          payload.dateEnd = roomDateEnd;
        }
        void saveRoomSettings(payload, showToast);
      }
      return true;
    }

    function commitRoomDates(){
      if(!ensureAuth()) return;
      if(!roomOpen) return toast("Room is closed.");
      const rk = ensureActiveRoom();
      if(!rk) return toast("Enter a room code to update room settings.");
      const normalized = normalizeRoomDateRange(elRoomDateStart.value, elRoomDateEnd.value, roomPreferredTz);
      roomDateStart = normalized.start;
      roomDateEnd = normalized.end;
      updateRoomSettingsUI();
      updateScheduleSubtitle();
      void saveRoomSettings({ dateStart: roomDateStart, dateEnd: roomDateEnd }, true);
    }

    function commitRoomMeetingMinutes(){
      if(!ensureAuth()) return;
      if(!roomOpen) return toast("Room is closed.");
      const rk = ensureActiveRoom();
      if(!rk) return toast("Enter a room code to update room settings.");
      const nextMinutes = normalizeMeetingMinutes(elRoomMeetingMinutes.value);
      if(!nextMinutes){
        updateRoomSettingsUI();
        return toast("Enter a valid meeting duration in minutes.");
      }
      roomMeetingMinutes = nextMinutes;
      updateRoomSettingsUI();
      void saveRoomSettings({ meetingMinutes: roomMeetingMinutes }, true);
    }

    function scheduleRoomDaysSave(){
      clearTimeout(roomDaysSaveTimer);
      roomDaysSaveTimer = setTimeout(() => {
        void saveRoomDays(roomDays, false);
      }, 400);
    }

    async function saveRoomDays(days, showToast=true){
      const rk = ensureActiveRoom();
      if(!rk) return;
      if(!ensureDb(false) || !ensureAuth(false)) return;

      const payload = {
        days,
        updatedAt: serverTimestamp()
      };

      try{
        await setDoc(doc(db, "rooms", rk), payload, { merge: true });
        if(showToast) toast("Room days updated.");
      }catch(err){
        console.error(err);
        if(showToast) toast("Failed to update room days.");
      }
    }

    async function saveRoomSettings(payload, showToast=true){
      const rk = ensureActiveRoom();
      if(!rk) return;
      if(!ensureDb(false) || !ensureAuth(false)) return;

      const update = { ...payload, updatedAt: serverTimestamp() };
      try{
        await setDoc(doc(db, "rooms", rk), update, { merge: true });
        if(showToast) toast("Room settings updated.");
      }catch(err){
        console.error(err);
        if(showToast) toast("Failed to update room settings.");
      }
    }

    async function resetRoom(){
      if(!ensureAuth()) return;
      const rk = ensureActiveRoom();
      if(!rk) return toast("Enter a room code first.");
      if(!ensureDb()) return;
      if(!isAdmin) return toast("Admin access required.");

      const confirmed = window.confirm(`Reset all selections for "${rk}"? This deletes all member entries.`);
      if(!confirmed) return;

      try{
        const snapshot = await getDocs(collection(db, "rooms", rk, "members"));
        if(snapshot.empty){
          userSelections = new Set();
          renderSlots();
          return toast("Room already empty.");
        }

        let batch = writeBatch(db);
        let count = 0;
        for(const docSnap of snapshot.docs){
          batch.delete(docSnap.ref);
          count += 1;
          if(count % 400 === 0){
            await batch.commit();
            batch = writeBatch(db);
          }
        }
        await batch.commit();

        userSelections = new Set();
        renderSlots();
        toast("Room reset complete.");
      }catch(err){
        console.error(err);
        toast("Room reset failed.");
      }
    }

    async function toggleRoomStatus(){
      if(!ensureAuth()) return;
      const rk = ensureActiveRoom();
      if(!rk) return toast("Enter a room code to update room status.");
      if(!ensureDb()) return;

      const name = elName.value.trim() || (authUser && authUser.displayName) || "";
      const email = getUserEmail();
      const nextOpen = !roomOpen;
      const payload = {
        isOpen: nextOpen,
        statusUpdatedAt: serverTimestamp(),
        statusByName: name,
        statusByEmail: email
      };

      try{
        await setDoc(doc(db, "rooms", rk), payload, { merge: true });
        toast(nextOpen ? "Room opened." : "Room closed.");
      }catch(err){
        console.error(err);
        toast("Failed to update room status.");
      }
    }

    // ---------- Counts / common slots ----------
    function computeCounts(){
      const members = Object.values(roomMembers);
      const counts = {};
      for(const dayId of roomDays){
        SLOT_START_MINUTES.forEach(minutes => counts[slotKey(dayId, minutes)] = 0);
      }

      for(const m of members){
        const slots = filterSlots(m.slots);
        if(!slots.length) continue;
        for(const s of slots){
          if(counts[s] !== undefined) counts[s] += 1;
        }
      }
      return { counts, memberCount: members.length };
    }

    function commonSlotsFromCounts(counts, memberCount){
      if(memberCount === 0) return new Set();
      const common = new Set();
      for(const k of Object.keys(counts)){
        if(counts[k] === memberCount) common.add(k);
      }
      return common;
    }

    // ---------- Rendering ----------
    function renderSlots(){
      hideCursorHint();
      elSlotGrid.innerHTML = "";
      updateHiddenDaysHint();
      const { counts, memberCount } = computeCounts();
      const common = commonSlotsFromCounts(counts, memberCount);
      renderTopSlots(counts, memberCount);
      const locked = isInteractionLocked();

      if(!activeDay){
        elSlotGrid.innerHTML = `<div class="memberCard"><div class="memberName">No days selected</div><div class="memberEmail">Select at least one day for this room.</div></div>`;
        return;
      }

      for(const minutes of SLOT_START_MINUTES){
        const key = slotKey(activeDay, minutes);

        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "slot";
        if(locked){
          btn.classList.add("isDisabled");
          btn.disabled = true;
        }

        if(userSelections.has(key)) btn.classList.add("selected");
        if(common.has(key) && memberCount > 0) btn.classList.add("common");

        const localBold = timeOnlyInZone(minutes, userTz);
        const preferredBold = timeOnlyInZone(minutes, roomPreferredTz);
        const localLabel = timeLabelInZone(minutes, userTz);
        const preferredLabel = timeLabelInZone(minutes, roomPreferredTz);
        const primaryLabel = showLocal ? localBold : preferredBold;
        const count = counts[key] || 0;
        const pct = memberCount ? Math.round((count / memberCount) * 100) : 0;

        btn.innerHTML = `
          <div class="top">
            <div class="labelEt">${primaryLabel}</div>
            <div class="count">
              <span>${count}/${memberCount || 0}</span>
              <span class="miniBar" aria-hidden="true"><span style="width:${pct}%"></span></span>
            </div>
          </div>
          <div class="labelLocal">${localLabel}</div>
          <div class="labelLocal">${preferredLabel}</div>
        `;

        btn.addEventListener("click", () => {
          const msg = lockMessage();
          if(msg) return toast(msg);
          if(!ensureActiveRoom()) return toast("Enter a room code first.");
          toggleSlot(key);
        });

        elSlotGrid.appendChild(btn);
      }
    }

    function renderTopSlots(counts, memberCount){
      if(!elTopSlots) return;
      updateTopViewUI();

      const showGraph = topView === "graph";
      if(!activeRoom){
        return renderTopMessage("Enter a room code to see top selections.", showGraph);
      }
      if(!authUser){
        return renderTopMessage("Sign in to view room data.", showGraph);
      }
      if(memberCount === 0){
        return renderTopMessage("No submissions yet.", showGraph);
      }

      if(showGraph){
        renderTopGraph(counts, memberCount);
        return;
      }

      if(!elTopSlotsList) return;
      const ranked = Object.entries(counts)
        .filter(([, count]) => count > 0)
        .sort((a, b) => {
          if(b[1] !== a[1]) return b[1] - a[1];
          return slotSortValue(a[0]) - slotSortValue(b[0]);
        })
        .slice(0, 7);

      if(ranked.length === 0){
        elTopSlotsList.innerHTML = `<div class="topSlotEmpty">No selections yet.</div>`;
        return;
      }

      elTopSlotsList.innerHTML = ranked.map(([slotKey, count]) => {
        const pct = memberCount ? Math.round((count / memberCount) * 100) : 0;
        const missing = getMissingForSlot(slotKey);
        const isFull = missing.length === 0;
        const missingText = missing.length ? `Missing: ${missing.join(", ")}` : "Full team available";
        const star = isFull ? `<span class="topSlotStar" title="Full team available">★</span>` : "";
        const label = escapeHtml(slotLabelRange(slotKey));
        return `
          <div class="topSlot">
            <div class="topSlotDetails">
              <div class="topSlotLabel">${label}${star}</div>
              <div class="topSlotMissing" title="${escapeHtml(missingText)}">${escapeHtml(missingText)}</div>
            </div>
            <div class="topSlotMeta">
              <span>${count}/${memberCount}</span>
              <span class="miniBar" aria-hidden="true"><span style="width:${pct}%"></span></span>
            </div>
          </div>
        `;
      }).join("");
    }

    function renderTopMessage(message, showGraph){
      if(showGraph){
        if(elTopSlotsGraph) elTopSlotsGraph.innerHTML = `<div class="topSlotEmpty">${escapeHtml(message)}</div>`;
        if(elTopSlotsList) elTopSlotsList.innerHTML = "";
      }else{
        if(elTopSlotsList) elTopSlotsList.innerHTML = `<div class="topSlotEmpty">${escapeHtml(message)}</div>`;
        if(elTopSlotsGraph) elTopSlotsGraph.innerHTML = "";
      }
    }

    function renderTopGraph(counts, memberCount){
      if(!elTopSlotsGraph) return;
      const zone = showLocal ? userTz : roomPreferredTz;
      const dayLabels = roomDays.map(dayId => ({ id: dayId, label: dayLabelShort(dayId) }));
      const timeLabels = SLOT_START_MINUTES.map(minutes => timeOnlyInZone(minutes, zone));

      const rows = SLOT_START_MINUTES.map((minutes, index) => {
        const timeLabel = timeLabels[index];
        const cells = dayLabels.map(({ id, label: dayLabel }) => {
          const key = slotKey(id, minutes);
          const count = counts[key] || 0;
          const pct = memberCount ? Math.round((count / memberCount) * 100) : 0;
          const isFull = memberCount > 0 && count === memberCount;
          const cellLabel = `${dayLabel} ${timeLabel} - ${count}/${memberCount}`;
          const star = isFull ? `<span class="heatmapStar" aria-hidden="true">★</span>` : "";
          return `<div class="heatmapCell" style="--heat:${pct}%;" title="${escapeHtml(cellLabel)}" aria-label="${escapeHtml(cellLabel)}">${star}</div>`;
        }).join("");
        return `
          <div class="heatmapTime">${escapeHtml(timeLabel)}</div>
          ${cells}
        `;
      }).join("");

      const axis = dayLabels.map(({ label }) => `<div class="heatmapDay">${escapeHtml(label)}</div>`).join("");
      const gridStyle = `style="--day-count:${dayLabels.length}"`;

      elTopSlotsGraph.innerHTML = `
        <div class="heatmap">
          <div class="heatmapScroll">
            <div class="heatmapAxis" ${gridStyle}>
              <div></div>
              ${axis}
            </div>
            <div class="heatmapGrid" ${gridStyle}>
              ${rows}
            </div>
          </div>
          <div class="heatmapLegend">
            <span>None</span>
            <span class="heatmapScale" aria-hidden="true"></span>
            <span>Everyone</span>
            <div class="heatmapNote"><span class="heatmapStar" aria-hidden="true">★</span> Full team availability</div>
          </div>
        </div>
      `;
    }

    function getMissingForSlot(slotKey){
      const members = Object.values(roomMembers);
      const missing = [];
      for(const m of members){
        const slots = filterSlots(m.slots);
        if(slots.includes(slotKey)) continue;
        const label = m.name || m.email || "Unknown";
        missing.push(label);
      }
      return missing;
    }

    function renderMembers(){
      const members = Object.values(roomMembers);
      elMemberCount.textContent = members.length;

      elMembers.innerHTML = "";

      if(!activeRoom){
        elMembers.innerHTML = `<div class="memberCard"><div class="memberName">Enter a room code to begin</div><div class="memberEmail">Team selections are scoped per room code.</div></div>`;
        return;
      }

      if(!authUser){
        elMembers.innerHTML = `<div class="memberCard"><div class="memberName">Sign in required</div><div class="memberEmail">Sign in to view and save room data.</div></div>`;
        return;
      }

      if(!db){
        elMembers.innerHTML = `<div class="memberCard"><div class="memberName">Firebase not configured</div><div class="memberEmail">Paste your config in index.html to load room data.</div></div>`;
        return;
      }

      if(members.length === 0){
        elMembers.innerHTML = `<div class="memberCard"><div class="memberName">No submissions yet</div><div class="memberEmail">Once someone saves their picks, they’ll appear here.</div></div>`;
        return;
      }

      members.sort((a,b) => (b.updatedAt ? b.updatedAt.getTime() : 0) - (a.updatedAt ? a.updatedAt.getTime() : 0));

      for(const m of members){
        const slots = filterSlots(m.slots);
        const chips = slots.length
          ? slots.slice().sort((a,b) => slotSortValue(a) - slotSortValue(b))
            .map(s => `<span class="chip">${slotLabelCompact(s)}</span>`).join("")
          : `<span class="chip none">No slots selected</span>`;
        const commentHtml = formatComment(m.comments);

        const updated = m.updatedAt || null;

        const card = document.createElement("div");
        card.className = "memberCard";
        card.innerHTML = `
          <div class="memberTop">
            <div>
              <div class="memberName">${escapeHtml(m.name || "Unnamed")}</div>
              <div class="memberEmail">${escapeHtml(m.email || "")}</div>
            </div>
            <div style="text-align:right">
              <div style="color:var(--muted); font-size:11px">${escapeHtml(formatMemberTimeZone(m.tz || ""))}</div>
              <div style="color:var(--muted); font-size:11px">${escapeHtml(updated ? updated.toLocaleString() : "")}</div>
            </div>
          </div>
          <div class="chips">${chips}</div>
          ${commentHtml ? `<div class="memberComment">${commentHtml}</div>` : ""}
        `;
        elMembers.appendChild(card);
      }
    }

    function slotLabelCompact(slotKey){
      const parsed = parseSlotKey(slotKey);
      const time = parsed.time || "";
      const minutes = parseTimeString(time);
      if(!Number.isFinite(minutes)) return slotKey;
      const dayLabel = parsed.dayId ? `${dayLabelShort(parsed.dayId)} ` : "";
      const zone = showLocal ? userTz : roomPreferredTz;
      return `${dayLabel}${timeLabelInZone(minutes, zone)}`;
    }

    function slotLabelRange(slotKey){
      const parsed = parseSlotKey(slotKey);
      const time = parsed.time || "";
      const startMinutes = parseTimeString(time);
      if(!Number.isFinite(startMinutes)) return slotKey;
      const duration = normalizeMeetingMinutes(roomMeetingMinutes) || 60;
      const endMinutes = startMinutes + duration;
      const zone = showLocal ? userTz : roomPreferredTz;
      const dayLabel = parsed.dayId ? `${dayLabelShort(parsed.dayId)} ` : "";
      const startLabel = timeOnlyInZone(startMinutes, zone);
      const endLabel = timeOnlyInZone(endMinutes, zone);
      const abbr = timeZoneAbbr(slotBaseDate(startMinutes), safeTimeZone(zone));
      const suffix = abbr ? ` ${abbr}` : "";
      return `${dayLabel}${startLabel} - ${endLabel}${suffix}`;
    }

    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function formatComment(text){
      const trimmed = String(text || "").trim();
      if(!trimmed) return "";
      return escapeHtml(trimmed).replaceAll("\n", "<br>");
    }

    function renderAll(){
      updateRoomLabel();
      renderDayControls();
      updateActionState();
      renderMembers();
    }

    // ---------- Interaction ----------
    function toggleSlot(key){
      if(userSelections.has(key)) userSelections.delete(key);
      else userSelections.add(key);
      renderSlots();
      autoSaveIfIdentified();
    }

    function autoSaveIfIdentified(){
      if(scheduleClosed || !roomOpen || !db || !authUser) return;
      const rk = roomKey();
      const name = elName.value.trim();
      const email = getUserEmail();
      if(!rk || !name || !isValidEmail(email)) return;
      if(rk !== activeRoom) setRoomFromInput();
      void saveMe(false);
    }

    async function saveMe(showToast=true){
      if(scheduleClosed) return toast("Scheduling is closed.");
      if(!roomOpen) return toast("Room is closed.");
      const rk = ensureActiveRoom();
      const name = elName.value.trim();
      const email = getUserEmail();

      if(!rk) return toast("Please enter a room code.");
      if(!name) return toast("Please enter your name.");
      if(!isValidEmail(email)) return toast("Please enter a valid email.");
      if(!ensureDb()) return;
      if(!ensureAuth()) return;

      const payload = {
        name,
        email,
        tz: userTz,
        slots: normalizeUserSelections(Array.from(userSelections)),
        comments: elCommentsInput ? elCommentsInput.value.trim() : "",
        updatedAt: serverTimestamp()
      };

      try{
        await setDoc(doc(db, "rooms", rk, "members", email), payload, { merge: true });
        if(showToast) toast("Saved.");
      }catch(err){
        console.error(err);
        toast("Save failed.");
      }
    }

    async function clearMyPicks(){
      if(scheduleClosed) return toast("Scheduling is closed.");
      if(!roomOpen) return toast("Room is closed.");
      const rk = ensureActiveRoom();
      const name = elName.value.trim();
      const email = getUserEmail();

      if(!rk) return toast("Please enter a room code.");
      if(!name) return toast("Please enter your name.");
      if(!isValidEmail(email)) return toast("Please enter a valid email.");
      if(!ensureDb()) return;
      if(!ensureAuth()) return;

      userSelections = new Set();
      renderSlots();

      const payload = {
        name,
        email,
        tz: userTz,
        slots: [],
        comments: elCommentsInput ? elCommentsInput.value.trim() : "",
        updatedAt: serverTimestamp()
      };

      try{
        await setDoc(doc(db, "rooms", rk, "members", email), payload, { merge: true });
        toast("Cleared your picks.");
      }catch(err){
        console.error(err);
        toast("Clear failed.");
      }
    }

    function exportJson(){
      const rk = ensureActiveRoom();
      if(!rk) return toast("Enter a room code first.");
      if(!ensureDb()) return;
      if(!ensureAuth()) return;

      const members = {};
      for(const [email, m] of Object.entries(roomMembers)){
        members[email] = {
          name: m.name || "",
          email: m.email || email,
          tz: m.tz || "",
          slots: Array.isArray(m.slots) ? m.slots : [],
          comments: m.comments || "",
          updatedAt: m.updatedAt ? m.updatedAt.toISOString() : null
        };
      }

      const payload = {
        room: rk,
        days: roomDays,
        preferredTz: roomPreferredTz,
        dateStart: roomDateStart,
        dateEnd: roomDateEnd,
        meetingMinutes: roomMeetingMinutes,
        exportedAt: new Date().toISOString(),
        members
      };

      const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `team-schedule-${rk}-${new Date().toISOString().slice(0,10)}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      toast("Exported.");
    }

    function toggleLocal(){
      showLocal = !showLocal;
      updateToggleLabel();
      updateTimeModeNote();
      updateHeatmapSubtitle();
      renderSlots();
      renderMembers();
    }

    function syncFromSnapshot(){
      if(!authUser) return;
      const email = getUserEmail();
      if(!isValidEmail(email)) return;

      const me = roomMembers[email];
      if(!me) return;

      if(!elName.value.trim()) elName.value = me.name || "";
      if(me.tz) setUserTimeZone(me.tz, { save: false, showToast: false });
      if(elCommentsInput && !elCommentsInput.value.trim() && me.comments){
        elCommentsInput.value = me.comments;
      }
      userSelections = new Set(normalizeUserSelections(me.slots));
    }

    function onRoomCommit(){
      clearTimeout(roomDebounce);
      setRoomFromInput();
    }

    // ---------- Wiring ----------
    elSaveBtn.addEventListener("click", () => void saveMe(true));
    elClearMeBtn.addEventListener("click", () => void clearMyPicks());
    elExportBtn.addEventListener("click", exportJson);
    elResetRoomBtn.addEventListener("click", () => void resetRoom());
    elToggleLocal.addEventListener("click", toggleLocal);
    elThemeBtn.addEventListener("click", toggleTheme);
    elLoadRoomBtn.addEventListener("click", loadRoomFromInput);
    elSignInBtn.addEventListener("click", () => setAuthMode("signin"));
    elSignUpBtn.addEventListener("click", () => setAuthMode("signup"));
    elEmailLinkBtn.addEventListener("click", () => setAuthMode("emaillink"));
    elGoogleBtn.addEventListener("click", () => void signInGoogle());
    elSignOutBtn.addEventListener("click", () => void signOutUser());
    elAuthSubmitBtn.addEventListener("click", submitAuth);
    elRoomToggleBtn.addEventListener("click", () => void toggleRoomStatus());

    if(elRoomTzSelect){
      elRoomTzSelect.addEventListener("change", () => {
        if(!ensureAuth()) return;
        if(!roomOpen) return toast("Room is closed.");
        const rk = ensureActiveRoom();
        if(!rk) return toast("Enter a room code to update room settings.");
        const ok = setRoomPreferredTz(elRoomTzSelect.value, { save: true, showToast: true });
        if(!ok) setSelectValue(elRoomTzSelect, roomPreferredTz);
      });
    }
    if(elRoomDateStart) elRoomDateStart.addEventListener("change", commitRoomDates);
    if(elRoomDateEnd) elRoomDateEnd.addEventListener("change", commitRoomDates);
    if(elRoomMeetingMinutes) elRoomMeetingMinutes.addEventListener("change", commitRoomMeetingMinutes);

    if(elTopRankBtn) elTopRankBtn.addEventListener("click", () => setTopView("rank"));
    if(elTopGraphBtn) elTopGraphBtn.addEventListener("click", () => setTopView("graph"));

    if(elCommentsToggle){
      elCommentsToggle.addEventListener("click", () => {
        if(scheduleClosed) return toast("Scheduling is closed.");
        if(!ensureAuth()) return;
        if(!roomOpen) return toast("Room is closed.");
        const rk = ensureActiveRoom();
        if(!rk) return toast("Enter a room code first.");
        setCommentsView(!showComments);
      });
    }
    if(elCommentsInput){
      elCommentsInput.addEventListener("input", () => {
        clearTimeout(commentSaveTimer);
        commentSaveTimer = setTimeout(autoSaveIfIdentified, 500);
      });
    }

    elRoomDays.addEventListener("click", (e) => {
      const btn = e.target.closest("button[data-day]");
      if(!btn) return;
      toggleRoomDay(btn.dataset.day);
    });

    elDayTabs.addEventListener("click", (e) => {
      const btn = e.target.closest("button[data-day]");
      if(!btn) return;
      if(showComments) setCommentsView(false);
      setActiveDay(btn.dataset.day);
    });

    elDaySelect.addEventListener("change", (e) => {
      if(showComments) setCommentsView(false);
      setActiveDay(e.target.value);
    });

    elRoom.addEventListener("keydown", (e) => { if(e.key === "Enter") { e.preventDefault(); onRoomCommit(); } });

    elSlotGrid.addEventListener("mousemove", (e) => {
      if(!shouldShowSignInHint()) return hideCursorHint();
      const target = document.elementFromPoint(e.clientX, e.clientY);
      const slot = target ? target.closest(".slot") : null;
      if(!slot || !elSlotGrid.contains(slot)) return hideCursorHint();
      showCursorHint(e.clientX, e.clientY);
    });
    elSlotGrid.addEventListener("mouseleave", hideCursorHint);

    elName.addEventListener("input", autoSaveIfIdentified);
    elAuthPassword.addEventListener("keydown", (e) => {
      if(e.key === "Enter"){
        e.preventDefault();
        submitAuth();
      }
    });
    elAuthEmail.addEventListener("keydown", (e) => {
      if(e.key !== "Enter") return;
      e.preventDefault();
      if(authMode === "emaillink") return submitAuth();
      if(authMode === "signin" || authMode === "signup") return elAuthPassword.focus();
    });
    if(elTzSelect){
      elTzSelect.addEventListener("change", commitTimeZoneSelect);
    }
    if(elTzResetBtn){
      elTzResetBtn.addEventListener("click", () => {
        if(!authUser) return toast("Sign in to change time zone.");
        setUserTimeZone(deviceTz, { save: true, showToast: false });
        toast("Time zone reset to device.");
      });
    }

    // ---------- Init ----------
    (function init(){
      initTheme();
      initTimeZoneOptions();
      initFirebase();
      handleEmailLinkSignIn();
      updateScheduleStatus();
      setRoomFromInput();
      renderAll();
      setInterval(updateScheduleStatus, 60 * 1000);
    })();
  </script>
</body>
</html>

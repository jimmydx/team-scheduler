<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Team Scheduling Tool</title>

  <style>
    /* Theme tokens
       - default: light
       - dark theme: html[data-theme="dark"]
    */

    :root{
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";

      /* Light theme */
      --bg:#f6f8fc;
      --panel:#ffffff;
      --panel2:#ffffff;
      --text:#0f172a;
      --muted:#475569;
      --border:rgba(15,23,42,.14);
      --accent:#0284c7;
      --accent2:#7c3aed;
      --good:#059669;
      --bad:#e11d48;
      --shadow: 0 12px 30px rgba(2,6,23,.10);

      --slotBg: rgba(2,6,23,.03);
      --slotBgHover: rgba(2,132,199,.06);
      --slotSelBg: rgba(5,150,105,.10);
      --slotComBg: rgba(2,132,199,.08);
      --toastBg: rgba(255,255,255,.92);

      --radius: 18px;
      --radius2: 22px;
    }

    html[data-theme="dark"]{
      --bg:#0b0f19;
      --panel:#10182a;
      --panel2:#0f1729;
      --text:#e9eef9;
      --muted:#94a3b8;
      --border:rgba(148,163,184,.22);
      --accent:#7dd3fc;
      --accent2:#c084fc;
      --good:#34d399;
      --bad:#fb7185;
      --shadow: 0 12px 30px rgba(0,0,0,.35);

      --slotBg: rgba(10,14,24,.46);
      --slotBgHover: rgba(125,211,252,.12);
      --slotSelBg: rgba(52,211,153,.10);
      --slotComBg: rgba(125,211,252,.10);
      --toastBg: rgba(15,23,41,.90);
    }

    *{box-sizing:border-box}
    html,body{height:100%}

    body{
      margin:0;
      font-family:var(--sans);
      background:
        radial-gradient(1200px 700px at 20% 10%, color-mix(in srgb, var(--accent) 20%, transparent), transparent 60%),
        radial-gradient(1000px 650px at 85% 15%, color-mix(in srgb, var(--accent2) 18%, transparent), transparent 55%),
        linear-gradient(180deg, color-mix(in srgb, var(--bg) 92%, #ffffff) 0%, var(--bg) 100%);
      color:var(--text);
      line-height:1.35;
    }

    .wrap{max-width:1100px;margin:0 auto;padding:28px 18px 54px;}

    header{
      display:flex;
      gap:18px;
      align-items:flex-start;
      justify-content:space-between;
      margin-bottom:18px;
    }

    h1{
      margin:0;
      font-size: clamp(22px, 4vw, 34px);
      letter-spacing:-.02em;
    }

    .subtitle{color:var(--muted);font-size:14px;margin-top:6px;}

    .badgeRow{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px;}
    .pill{
      border:1px solid var(--border);
      background:color-mix(in srgb, var(--panel) 86%, transparent);
      padding:8px 10px;
      border-radius:999px;
      color:var(--muted);
      font-size:12px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .dot{width:8px;height:8px;border-radius:99px;background:var(--accent);}

    .grid{
      display:grid;
      grid-template-columns: 380px 1fr;
      gap:14px;
    }
    @media (max-width: 980px){ .grid{grid-template-columns:1fr;} }

    .panel{
      background: linear-gradient(180deg, color-mix(in srgb, var(--panel) 92%, transparent), color-mix(in srgb, var(--panel2) 88%, transparent));
      border:1px solid var(--border);
      border-radius:var(--radius2);
      box-shadow:var(--shadow);
      overflow:hidden;
    }

    .panelHead{
      padding:16px 16px 12px;
      border-bottom:1px solid color-mix(in srgb, var(--border) 72%, transparent);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }

    .panelHead h2{margin:0;font-size:16px;letter-spacing:-.01em;}
    .panelHead p{margin:6px 0 0;color:var(--muted);font-size:13px;}
    .panelBody{padding:16px;}

    .field{display:flex;flex-direction:column;gap:6px;margin-bottom:14px;}
    .inputRow{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
    .inputRow input{flex:1;}
    .btnSubtle{padding:9px 10px;font-size:12px;white-space:nowrap;}
    .authBox{
      border:1px solid var(--border);
      background: color-mix(in srgb, var(--panel) 86%, transparent);
      border-radius:16px;
      padding:12px;
      margin-bottom:14px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .authRow{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;}
    .authTitle{font-weight:700;font-size:13px;}
    .authSub{color:var(--muted);font-size:12px;}
    .authTop{display:flex;flex-direction:column;gap:10px;}
    .authPrimary{width:100%;}
    .authDivider{
      display:flex;
      align-items:center;
      gap:10px;
      color:var(--muted);
      font-size:12px;
      margin:6px 0;
    }
    .authDivider::before,
    .authDivider::after{
      content:"";
      flex:1;
      height:1px;
      background: color-mix(in srgb, var(--border) 80%, transparent);
    }
    .authActions{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;}
    .authActions button.active{
      border-color:color-mix(in srgb, var(--accent) 55%, transparent);
      background: var(--slotBgHover);
    }
    .authFields{display:none;flex-direction:column;gap:10px;margin-top:6px;}
    .authFields.active{display:flex;}
    .authProfile{margin-top:10px;}
    .authNote{text-align:center;}
    .roomTag{font-weight:700;color:var(--accent);}
    .roomMeta{margin-top:6px;}
    .dayHint{margin-top:0;}

    .dayChoices,
    .dayTabs{display:flex;gap:8px;flex-wrap:wrap;}
    .dayChoice,
    .dayTab{
      border:1px solid color-mix(in srgb, var(--border) 85%, transparent);
      background: var(--slotBg);
      border-radius:999px;
      padding:8px 10px;
      font-size:12px;
      font-weight:600;
      letter-spacing:-.01em;
      cursor:pointer;
    }
    .dayChoice.active,
    .dayTab.active{
      border-color:color-mix(in srgb, var(--accent) 60%, transparent);
      background: var(--slotBgHover);
    }

    .daySwitch{padding:10px 14px 0; display:flex; flex-direction:column; gap:10px;}
    .daySelect{display:none;}
    @media (max-width: 640px){
      .dayTabs{display:none;}
      .daySelect{display:block;}
    }
    label{font-size:12px;color:var(--muted);}

    input{
      width:100%;
      padding:11px 12px;
      border-radius:14px;
      border:1px solid color-mix(in srgb, var(--border) 90%, transparent);
      background: color-mix(in srgb, var(--panel) 80%, transparent);
      color:var(--text);
      outline:none;
      transition:.15s;
    }

    input:focus{
      border-color:color-mix(in srgb, var(--accent) 70%, transparent);
      box-shadow:0 0 0 4px color-mix(in srgb, var(--accent) 18%, transparent);
    }

    select{
      width:100%;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid color-mix(in srgb, var(--border) 90%, transparent);
      background: color-mix(in srgb, var(--panel) 80%, transparent);
      color:var(--text);
      outline:none;
      transition:.15s;
    }

    select:focus{
      border-color:color-mix(in srgb, var(--accent) 70%, transparent);
      box-shadow:0 0 0 4px color-mix(in srgb, var(--accent) 18%, transparent);
    }

    .hint{font-size:12px;color:var(--muted);margin-top:-6px;}
    .hint.footnote{font-size:11px;color:color-mix(in srgb, var(--muted) 80%, transparent);}

    button{
      border:1px solid color-mix(in srgb, var(--border) 90%, transparent);
      background: linear-gradient(180deg, color-mix(in srgb, var(--accent) 14%, transparent), color-mix(in srgb, var(--panel) 70%, transparent));
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:600;
      letter-spacing:-.01em;
      transition:.15s;
      user-select:none;
    }
    button:hover{transform: translateY(-1px); border-color:color-mix(in srgb, var(--accent) 55%, transparent);}
    button:active{transform: translateY(0);}

    button.isDisabled,
    .slot.isDisabled{
      opacity:.6;
      cursor:not-allowed;
      transform:none;
    }
    button.isDisabled:hover,
    .slot.isDisabled:hover{
      transform:none;
      border-color:color-mix(in srgb, var(--border) 90%, transparent);
    }

    .btnDanger{
      background: linear-gradient(180deg, color-mix(in srgb, var(--bad) 12%, transparent), color-mix(in srgb, var(--panel) 70%, transparent));
    }

    .row{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;}

    .slotGrid{
      padding:14px 14px 16px;
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap:10px;
    }
    @media (max-width: 560px){ .slotGrid{grid-template-columns: repeat(2, minmax(0, 1fr));} }

    .slot{
      border:1px solid color-mix(in srgb, var(--border) 78%, transparent);
      background: var(--slotBg);
      border-radius:16px;
      padding:10px 10px;
      cursor:pointer;
      transition:.15s;
      display:flex;
      flex-direction:column;
      gap:6px;
      min-height:74px;
      text-align:left;
    }

    .slot:hover{
      transform: translateY(-1px);
      border-color:color-mix(in srgb, var(--accent) 55%, transparent);
      background: var(--slotBgHover);
    }

    .slot.selected{
      border-color:color-mix(in srgb, var(--good) 65%, transparent);
      box-shadow:0 0 0 4px color-mix(in srgb, var(--good) 14%, transparent);
      background: var(--slotSelBg);
    }

    .slot.common{
      border-color: color-mix(in srgb, var(--accent) 65%, transparent);
      box-shadow:0 0 0 4px color-mix(in srgb, var(--accent) 14%, transparent);
      background: var(--slotComBg);
    }

    .slot .top{display:flex;align-items:center;justify-content:space-between;gap:10px;}
    .slot .labelEt{font-weight:800;font-size:13px;}
    .slot .labelLocal{font-family:var(--mono);font-size:11px;color:var(--muted);}

    .count{font-size:11px;color:var(--muted);display:flex;align-items:center;gap:6px;white-space:nowrap;}
    .miniBar{width:46px;height:6px;border-radius:999px;background: color-mix(in srgb, var(--border) 70%, transparent);overflow:hidden;}
    .miniBar > span{display:block;height:100%;width:0;background: linear-gradient(90deg, color-mix(in srgb, var(--accent) 85%, transparent), color-mix(in srgb, var(--accent2) 85%, transparent));}

    .legend{
      padding:12px 14px 14px;
      border-top:1px solid color-mix(in srgb, var(--border) 72%, transparent);
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }

    .key{display:flex;gap:12px;flex-wrap:wrap;align-items:center;}
    .keyItem{display:flex;gap:8px;align-items:center;color:var(--muted);font-size:12px;}
    .swatch{width:10px;height:10px;border-radius:4px;border:1px solid color-mix(in srgb, var(--border) 90%, transparent);}
    .swSel{background:color-mix(in srgb, var(--good) 22%, transparent); border-color:color-mix(in srgb, var(--good) 70%, transparent);}
    .swCom{background:color-mix(in srgb, var(--accent) 20%, transparent); border-color:color-mix(in srgb, var(--accent) 70%, transparent);}

    .footerPanel{margin-top:14px;}

    .members{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:10px;
      padding:14px;
    }
    @media (max-width: 760px){ .members{grid-template-columns:1fr;} }

    .memberCard{
      border:1px solid color-mix(in srgb, var(--border) 72%, transparent);
      background: var(--slotBg);
      border-radius:16px;
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height:86px;
    }

    .memberTop{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;}
    .memberName{font-weight:800;}
    .memberEmail{color:var(--muted);font-size:12px;word-break:break-all;}

    .chips{display:flex;gap:8px;flex-wrap:wrap;}
    .chip{
      font-family:var(--mono);
      font-size:11px;
      color:var(--text);
      background: color-mix(in srgb, var(--accent) 12%, transparent);
      border:1px solid color-mix(in srgb, var(--accent) 20%, transparent);
      padding:6px 8px;
      border-radius:999px;
    }
    .chip.none{
      color:var(--muted);
      background: color-mix(in srgb, var(--border) 22%, transparent);
      border-color: color-mix(in srgb, var(--border) 40%, transparent);
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background: var(--toastBg);
      border:1px solid color-mix(in srgb, var(--border) 72%, transparent);
      padding:10px 12px;
      border-radius:999px;
      color:var(--text);
      font-size:12.5px;
      box-shadow:var(--shadow);
      display:none;
      gap:10px;
      align-items:center;
      z-index:50;
      backdrop-filter: blur(10px);
    }
    .toast.show{display:flex;}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Team Scheduling</h1>
        <div class="subtitle">
          Select your preferred 1-hour meeting slots. The team list updates as people submit.
        </div>

        <div class="badgeRow">
          <div class="pill"><span class="dot" style="background:var(--good)"></span><span id="tzPill">Your time zone: …</span></div>
        </div>
      </div>

      <div style="display:flex;flex-direction:column;align-items:flex-end;gap:10px">
        <button id="themeBtn" type="button" style="padding:9px 10px">Toggle light/dark theme</button>
      </div>
    </header>

    <div class="grid">
      <!-- Identity -->
      <section class="panel">
        <div class="panelHead">
          <div>
            <h2>User info</h2>
            <p>Selections are scoped by room code.</p>
          </div>
        </div>

        <div class="panelBody">
          <div class="authBox">
            <div class="authRow">
              <div>
                <div class="authTitle">Access</div>
                <div class="authSub" id="authStatus">Not signed in</div>
              </div>
              <button id="signOutBtn" class="btnSubtle" type="button" style="display:none">Sign out</button>
            </div>
            <div id="authControls">
              <div class="authTop">
                <button id="googleBtn" class="authPrimary" type="button">Google sign-in</button>
              </div>
              <div class="authDivider"><span>or</span></div>
              <div class="authActions">
                <button id="signInBtn" type="button" aria-expanded="false">Sign in</button>
                <button id="signUpBtn" type="button" aria-expanded="false">Create account</button>
                <button id="emailLinkBtn" type="button" aria-expanded="false">Email link</button>
              </div>
              <div id="authFields" class="authFields" aria-live="polite">
                <div class="field" id="authEmailField">
                  <label for="authEmail">Login email</label>
                  <input id="authEmail" type="email" placeholder="you@company.com" autocomplete="email" />
                </div>
                <div class="field" id="authPasswordField">
                  <label for="authPassword">Password</label>
                  <input id="authPassword" type="password" placeholder="••••••••" autocomplete="current-password" />
                </div>
                <div class="row" style="justify-content:flex-start">
                  <button id="authSubmitBtn" type="button">Continue</button>
                </div>
                <div class="hint" id="authHint"></div>
              </div>
            </div>
            <div id="authProfile" class="authProfile" style="display:none">
              <div class="field">
                <label for="name">Display name</label>
                <input id="name" placeholder="e.g., Alex Johnson" autocomplete="name" />
                <div class="hint">Shown in the team list. Your sign-in email is used automatically.</div>
              </div>
              <div class="field">
                <label for="tzInput">Time zone (IANA)</label>
                <input id="tzInput" placeholder="e.g., America/New_York" autocomplete="off" list="tzOptions" />
                <datalist id="tzOptions"></datalist>
                <div class="hint">Used for local time display and saved with your entry.</div>
                <div class="row" style="justify-content:flex-start">
                  <button id="tzResetBtn" class="btnSubtle" type="button">Use device time zone</button>
                </div>
              </div>
            </div>
            <div class="hint authNote">Sign in to view and save room selections.</div>
          </div>

          <div class="field">
            <label for="room">Room code / Team name</label>
            <div class="inputRow">
              <input id="room" placeholder="e.g., physics-lab / team-standup" autocomplete="off" required />
              <button id="copyRoomBtn" class="btnSubtle" type="button">Copy</button>
            </div>
            <div class="hint footnote">(room codes are lowercased; spaces become hyphens.)</div>
          </div>

          <div class="field">
            <label>Active days for current room/team:</label>
            <div class="dayChoices" id="roomDays"></div>
          </div>

          <div class="field">
            <label>Room status</label>
            <div class="row" style="justify-content:flex-start">
              <div class="pill">
                <span class="dot" id="roomStatusDot" style="background:var(--good)"></span>
                <span id="roomStatusLabel">Room open</span>
              </div>
              <button id="roomToggleBtn" type="button">Close room</button>
            </div>
            <div class="hint roomMeta" id="roomStatusMeta" style="display:none"></div>
          </div>

          <div class="row" style="margin-top:14px">
            <button id="saveBtn" type="button">Save / Update</button>
            <button id="clearMeBtn" class="btnDanger" type="button">Clear my picks</button>
          </div>
        </div>
      </section>

      <!-- Slots -->
      <section class="panel">
        <div class="panelHead">
          <div>
            <h2>Select 1-hour slots: <span id="slotRoomLabel" class="roomTag"></span></h2>
            <p>Eastern time shown in bold; your local time below.</p>
          </div>
          <div style="text-align:right">
            <div style="color:var(--muted); font-size:12px">Members submitted</div>
            <div style="font-weight:900; font-size:20px" id="memberCount">0</div>
          </div>
        </div>

        <div class="daySwitch">
          <div class="dayTabs" id="dayTabs"></div>
          <select id="daySelect" class="daySelect" aria-label="Select day"></select>
          <div id="hiddenDaysHint" class="hint dayHint" style="display:none"></div>
        </div>

        <div class="slotGrid" id="slotGrid"></div>

        <div class="legend">
          <div class="key">
            <div class="keyItem"><span class="swatch swSel"></span> Selected by you</div>
            <div class="keyItem"><span class="swatch swCom"></span> Selected by everyone</div>
          </div>
          <div class="keyItem" style="gap:10px">
            <span style="color:var(--muted)">Showing times in:</span>
            <button id="toggleLocal" type="button" style="padding:9px 10px">Your local time (LT)</button>
          </div>
        </div>
      </section>
    </div>

    <!-- Team list -->
    <section class="panel footerPanel">
      <div class="panelHead">
        <div>
          <h2>Current team selections (this room)</h2>
          <p>Watch convergence by finding slots selected by everyone.</p>
        </div>
          <div class="row" style="gap:10px">
            <button id="exportBtn" type="button">Export JSON</button>
            <button id="resetRoomBtn" class="btnDanger" type="button">Reset room</button>
            <div class="pill" id="resetRoomNote">
              <span class="dot" style="background:var(--bad)"></span>
              <span id="resetRoomNoteText">Admin only</span>
            </div>
          </div>
      </div>

      <div class="members" id="members"></div>
    </section>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite">
    <span id="toastMsg"></span>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signInWithPopup, GoogleAuthProvider, signOut, sendSignInLinkToEmail, isSignInWithEmailLink, signInWithEmailLink } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getFirestore, doc, setDoc, collection, onSnapshot, serverTimestamp, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD7cfuYuOYIUoLavGJlfua4UYfawDcZMT0",
      authDomain: "team-scheduler-7ddab.firebaseapp.com",
      projectId: "team-scheduler-7ddab",
      storageBucket: "team-scheduler-7ddab.firebasestorage.app",
      messagingSenderId: "986652351844",
      appId: "1:986652351844:web:09874d46b6e10b4572ae71",
      measurementId: "G-72MHNL8GFY"
    };

    const THEME_KEY = "teamScheduler_theme";
    const EMAIL_LINK_KEY = "teamScheduler_emailLink";

    // 1-hour slots starting in ET, 9..16 inclusive
    const SLOT_START_HOURS_ET = Array.from({length: 8}, (_, i) => 9 + i);
    const DAY_OPTIONS = [
      { id: "mon", short: "Mon", long: "Monday" },
      { id: "tue", short: "Tue", long: "Tuesday" },
      { id: "wed", short: "Wed", long: "Wednesday" },
      { id: "thu", short: "Thu", long: "Thursday" },
      { id: "fri", short: "Fri", long: "Friday" },
      { id: "sat", short: "Sat", long: "Saturday" },
      { id: "sun", short: "Sun", long: "Sunday" }
    ];
    const DEFAULT_ROOM_DAYS = ["mon", "tue", "wed", "thu", "fri"];
    const REF_DATE = { year: 2026, month: 5, day: 1 }; // stable conversion date
    const ET_TIMEZONE = "America/New_York";
    const SCHEDULE_CLOSE_ET = makeZonedDate(2026, 5, 15, 23, 59, ET_TIMEZONE, 59);
    const DAY_LOOKUP = new Map(DAY_OPTIONS.map(d => [d.id, d]));
    const DAY_ORDER = new Map(DAY_OPTIONS.map((d, i) => [d.id, i]));
    const SLOT_TIME_SET = new Set(SLOT_START_HOURS_ET.map(h => `${String(h).padStart(2,"0")}:00`));

    const elRoom = document.getElementById("room");
    const elName = document.getElementById("name");
    const elSlotGrid = document.getElementById("slotGrid");
    const elRoomDays = document.getElementById("roomDays");
    const elDayTabs = document.getElementById("dayTabs");
    const elDaySelect = document.getElementById("daySelect");
    const elHiddenDaysHint = document.getElementById("hiddenDaysHint");
    const elMembers = document.getElementById("members");
    const elMemberCount = document.getElementById("memberCount");
    const elSlotRoomLabel = document.getElementById("slotRoomLabel");
    const elTzPill = document.getElementById("tzPill");
    const elRoomStatusDot = document.getElementById("roomStatusDot");
    const elRoomStatusLabel = document.getElementById("roomStatusLabel");
    const elRoomStatusMeta = document.getElementById("roomStatusMeta");
    const elRoomToggleBtn = document.getElementById("roomToggleBtn");

    const elSaveBtn = document.getElementById("saveBtn");
    const elClearMeBtn = document.getElementById("clearMeBtn");
    const elExportBtn = document.getElementById("exportBtn");
    const elResetRoomBtn = document.getElementById("resetRoomBtn");
    const elResetRoomNote = document.getElementById("resetRoomNote");
    const elResetRoomNoteText = document.getElementById("resetRoomNoteText");
    const elToggleLocal = document.getElementById("toggleLocal");
    const elThemeBtn = document.getElementById("themeBtn");
    const elCopyRoomBtn = document.getElementById("copyRoomBtn");
    const elAuthEmail = document.getElementById("authEmail");
    const elAuthPassword = document.getElementById("authPassword");
    const elSignInBtn = document.getElementById("signInBtn");
    const elSignUpBtn = document.getElementById("signUpBtn");
    const elEmailLinkBtn = document.getElementById("emailLinkBtn");
    const elGoogleBtn = document.getElementById("googleBtn");
    const elSignOutBtn = document.getElementById("signOutBtn");
    const elAuthStatus = document.getElementById("authStatus");
    const elAuthControls = document.getElementById("authControls");
    const elAuthFields = document.getElementById("authFields");
    const elAuthEmailField = document.getElementById("authEmailField");
    const elAuthPasswordField = document.getElementById("authPasswordField");
    const elAuthSubmitBtn = document.getElementById("authSubmitBtn");
    const elAuthHint = document.getElementById("authHint");
    const elAuthProfile = document.getElementById("authProfile");
    const elTzInput = document.getElementById("tzInput");
    const elTzResetBtn = document.getElementById("tzResetBtn");
    const elTzOptions = document.getElementById("tzOptions");

    const elToast = document.getElementById("toast");
    const elToastMsg = document.getElementById("toastMsg");

    const deviceTz = Intl.DateTimeFormat().resolvedOptions().timeZone || "UTC";
    let userTz = deviceTz;

    let showLocal = true;
    let userSelections = new Set();
    let activeRoom = "";
    let roomMembers = {};
    let roomDays = DEFAULT_ROOM_DAYS.slice();
    let roomDaysSet = new Set(roomDays);
    let activeDay = roomDays[0] || "";
    let roomOpen = true;
    let roomStatusUpdatedAt = null;
    let roomStatusByName = "";
    let roomStatusByEmail = "";
    let roomAdmins = [];
    let isAdmin = false;
    let roomUnsub = null;
    let roomDocUnsub = null;
    let roomConfigSeeded = false;
    let roomDaysSaveTimer = null;
    let scheduleClosed = false;
    let app = null;
    let auth = null;
    let authUser = null;
    let authMode = "";
    let db = null;
    let roomDebounce = null;
    updateTzPill();

    // ---------- Theme ----------
    function applyTheme(theme){
      if(theme === "dark") document.documentElement.setAttribute("data-theme","dark");
      else document.documentElement.removeAttribute("data-theme");
      localStorage.setItem(THEME_KEY, theme);
    }

    function toggleTheme(){
      const isDark = document.documentElement.getAttribute("data-theme") === "dark";
      applyTheme(isDark ? "light" : "dark");
      toast(isDark ? "Light theme" : "Dark theme");
    }

    function initTheme(){
      const saved = localStorage.getItem(THEME_KEY);
      if(saved === "dark" || saved === "light") applyTheme(saved);
      else {
        const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
        applyTheme(prefersDark ? "dark" : "light");
      }
    }

    // ---------- Time zone ----------
    function updateTzPill(){
      if(!elTzPill) return;
      const note = authUser ? "change below" : "you can change this by signing in";
      elTzPill.textContent = `Your time zone: ${userTz} (${note})`;
    }

    function isValidTimeZone(tz){
      if(!tz) return false;
      try{
        Intl.DateTimeFormat("en-US", { timeZone: tz }).format();
        return true;
      }catch{
        return false;
      }
    }

    function safeTimeZone(tz){
      if(isValidTimeZone(tz)) return tz;
      if(isValidTimeZone(deviceTz)) return deviceTz;
      return "UTC";
    }

    function setUserTimeZone(nextTz, { save = true, showToast = true } = {}){
      const trimmed = String(nextTz || "").trim();
      const candidate = trimmed || deviceTz;
      if(!isValidTimeZone(candidate)){
        if(showToast) toast("Enter a valid IANA time zone.");
        return false;
      }
      if(candidate === userTz) return true;
      userTz = candidate;
      if(elTzInput) elTzInput.value = candidate;
      updateTzPill();
      renderSlots();
      if(save) autoSaveIfIdentified();
      return true;
    }

    function initTimeZoneOptions(){
      if(!elTzOptions) return;
      if(typeof Intl.supportedValuesOf !== "function") return;
      const zones = Intl.supportedValuesOf("timeZone");
      elTzOptions.innerHTML = zones.map(zone => `<option value="${zone}"></option>`).join("");
    }

    function commitTimeZoneInput(){
      if(!authUser) return toast("Sign in to change time zone.");
      if(!elTzInput) return;
      const ok = setUserTimeZone(elTzInput.value, { save: true, showToast: true });
      if(!ok) elTzInput.value = userTz;
    }

    // ---------- Toast ----------
    function toast(msg){
      elToastMsg.textContent = msg;
      elToast.classList.add("show");
      clearTimeout(toast._t);
      toast._t = setTimeout(()=> elToast.classList.remove("show"), 1800);
    }

    async function copyRoomCode(){
      const rk = roomKey();
      if(!rk) return toast("Enter a room code first.");
      elRoom.value = rk;
      onRoomCommit();

      const ok = await copyToClipboard(rk);
      toast(ok ? "Room code copied." : "Copy failed.");
    }

    async function copyToClipboard(text){
      if(navigator.clipboard && window.isSecureContext){
        try{
          await navigator.clipboard.writeText(text);
          return true;
        }catch{}
      }
      return fallbackCopy(text);
    }

    function fallbackCopy(text){
      const ta = document.createElement("textarea");
      ta.value = text;
      ta.setAttribute("readonly", "");
      ta.style.position = "fixed";
      ta.style.left = "-9999px";
      document.body.appendChild(ta);
      ta.select();
      let ok = false;
      try{
        ok = document.execCommand("copy");
      }catch{}
      ta.remove();
      return ok;
    }

    // ---------- Firebase ----------
    function initFirebase(){
      try{
        if(!firebaseConfig || !firebaseConfig.apiKey) throw new Error("Missing Firebase config");
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        initAuth();
      }catch(err){
        console.warn("Firebase init failed. Paste your config in index.html.", err);
      }
    }

    function ensureDb(showToast=true){
      if(db) return true;
      if(showToast) toast("Add Firebase config first.");
      return false;
    }

    function ensureAuth(showToast=true){
      if(authUser) return true;
      if(showToast) toast("Sign in to access this room.");
      return false;
    }

    function initAuth(){
      if(!auth) return;
      onAuthStateChanged(auth, (user) => {
        authUser = user || null;
        updateAuthUI();

        if(authUser && authUser.displayName && !elName.value.trim()){
          elName.value = authUser.displayName;
        }

        if(!authUser && roomUnsub){
          roomUnsub();
          roomUnsub = null;
        }
        if(!authUser && roomDocUnsub){
          roomDocUnsub();
          roomDocUnsub = null;
        }

        if(!authUser){
          roomMembers = {};
          userSelections = new Set();
          roomDays = DEFAULT_ROOM_DAYS.slice();
          roomDaysSet = new Set(roomDays);
          activeDay = roomDays[0] || "";
          roomOpen = true;
          roomStatusUpdatedAt = null;
          roomStatusByName = "";
          roomStatusByEmail = "";
          roomAdmins = [];
          isAdmin = false;
          setUserTimeZone(deviceTz, { save: false, showToast: false });
        }

        setRoomFromInput();
        updateActionState();
        renderAll();
      });
    }

    function updateAuthUI(){
      if(authUser){
        elAuthStatus.textContent = `Signed in as ${authUser.email || "user"}`;
        if(authUser.email) elAuthEmail.value = authUser.email;
        elAuthPassword.value = "";
        elAuthControls.style.display = "none";
        elSignOutBtn.style.display = "inline-flex";
        elAuthProfile.style.display = "block";
        elName.disabled = false;
        if(elTzInput){
          elTzInput.disabled = false;
          elTzInput.value = userTz;
        }
        if(elTzResetBtn) elTzResetBtn.disabled = false;
      }else{
        elAuthStatus.textContent = "Not signed in";
        elAuthControls.style.display = "block";
        elSignOutBtn.style.display = "none";
        elAuthProfile.style.display = "none";
        elName.disabled = true;
        if(elTzInput){
          elTzInput.disabled = true;
          elTzInput.value = userTz;
        }
        if(elTzResetBtn) elTzResetBtn.disabled = true;
        setAuthMode("");
      }
      updateAdminState();
      updateTzPill();
    }

    function setAuthMode(mode){
      authMode = mode || "";
      const hasMode = !!authMode;
      const showEmail = authMode === "signin" || authMode === "signup" || authMode === "emaillink";
      const showPassword = authMode === "signin" || authMode === "signup";

      elAuthFields.classList.toggle("active", hasMode);
      elAuthEmailField.style.display = showEmail ? "block" : "none";
      elAuthPasswordField.style.display = showPassword ? "block" : "none";
      elAuthSubmitBtn.style.display = hasMode ? "inline-flex" : "none";

      const labelMap = {
        signin: "Sign in",
        signup: "Create account",
        emaillink: "Send email link"
      };
      elAuthSubmitBtn.textContent = labelMap[authMode] || "Continue";
      elAuthHint.textContent = authMode === "emaillink"
        ? "We will email you a sign-in link."
        : "";

      elSignInBtn.setAttribute("aria-expanded", authMode === "signin" ? "true" : "false");
      elSignUpBtn.setAttribute("aria-expanded", authMode === "signup" ? "true" : "false");
      elEmailLinkBtn.setAttribute("aria-expanded", authMode === "emaillink" ? "true" : "false");
      elSignInBtn.classList.toggle("active", authMode === "signin");
      elSignUpBtn.classList.toggle("active", authMode === "signup");
      elEmailLinkBtn.classList.toggle("active", authMode === "emaillink");

      if(showEmail) elAuthEmail.focus();
    }

    function submitAuth(){
      if(authMode === "signin") return void signInEmail();
      if(authMode === "signup") return void signUpEmail();
      if(authMode === "emaillink") return void sendEmailLink();
    }

    function authErrorMessage(err){
      const code = err && err.code ? err.code : "";
      const map = {
        "auth/invalid-email": "Enter a valid email address.",
        "auth/user-not-found": "No account found. Use Create account.",
        "auth/wrong-password": "Incorrect password.",
        "auth/email-already-in-use": "Email already in use. Try Sign in.",
        "auth/weak-password": "Password should be at least 6 characters.",
        "auth/popup-closed-by-user": "Popup closed.",
        "auth/unauthorized-domain": "Add this domain to Firebase Auth settings.",
        "auth/account-exists-with-different-credential": "Account exists with a different sign-in method.",
        "auth/operation-not-allowed": "Enable this sign-in method in Firebase Auth.",
        "auth/invalid-action-code": "Invalid or expired email link.",
        "auth/expired-action-code": "Email link expired. Request a new one.",
        "auth/invalid-continue-uri": "Invalid sign-in link URL. Check authorized domains."
      };
      return map[code] || "Authentication failed.";
    }

    async function signInEmail(){
      if(!auth) return toast("Add Firebase config first.");
      const email = elAuthEmail.value.trim();
      const password = elAuthPassword.value;
      if(!email || !password) return toast("Enter email and password.");
      try{
        await signInWithEmailAndPassword(auth, email, password);
        elAuthPassword.value = "";
        toast("Signed in.");
      }catch(err){
        toast(authErrorMessage(err));
      }
    }

    async function signUpEmail(){
      if(!auth) return toast("Add Firebase config first.");
      const email = elAuthEmail.value.trim();
      const password = elAuthPassword.value;
      if(!email || !password) return toast("Enter email and password.");
      try{
        await createUserWithEmailAndPassword(auth, email, password);
        elAuthPassword.value = "";
        toast("Account created.");
      }catch(err){
        toast(authErrorMessage(err));
      }
    }

    function getActionUrl(){
      if(window.location.protocol === "file:" || window.location.origin === "null") return "";
      return `${window.location.origin}${window.location.pathname}`;
    }

    async function sendEmailLink(){
      if(!auth) return toast("Add Firebase config first.");
      const email = elAuthEmail.value.trim();
      if(!email) return toast("Enter your email first.");

      const actionUrl = getActionUrl();
      if(!actionUrl) return toast("Email link requires a hosted URL (not file://).");

      try{
        await sendSignInLinkToEmail(auth, email, {
          url: actionUrl,
          handleCodeInApp: true
        });
        localStorage.setItem(EMAIL_LINK_KEY, email);
        toast("Email link sent. Check your inbox.");
      }catch(err){
        toast(authErrorMessage(err));
      }
    }

    async function handleEmailLinkSignIn(){
      if(!auth || !isSignInWithEmailLink(auth, window.location.href)) return;
      let email = localStorage.getItem(EMAIL_LINK_KEY) || elAuthEmail.value.trim();
      if(!email){
        email = window.prompt("Confirm your email to finish sign-in") || "";
      }
      if(!email) return toast("Email required to finish sign-in.");

      try{
        await signInWithEmailLink(auth, email, window.location.href);
        localStorage.removeItem(EMAIL_LINK_KEY);
        toast("Signed in.");
        if(window.history && window.history.replaceState){
          const cleanUrl = `${window.location.origin}${window.location.pathname}`;
          window.history.replaceState({}, document.title, cleanUrl);
        }
      }catch(err){
        toast(authErrorMessage(err));
      }
    }

    async function signInGoogle(){
      if(!auth) return toast("Add Firebase config first.");
      try{
        const provider = new GoogleAuthProvider();
        await signInWithPopup(auth, provider);
        toast("Signed in.");
      }catch(err){
        toast(authErrorMessage(err));
      }
    }

    async function signOutUser(){
      if(!auth) return;
      try{
        await signOut(auth);
        toast("Signed out.");
      }catch(err){
        toast(authErrorMessage(err));
      }
    }

    // ---------- Room handling ----------
    function normalizeRoom(room){
      return String(room || "")
        .trim()
        .toLowerCase()
        .replace(/\s+/g, "-")
        .replace(/[^a-z0-9-_]/g, "");
    }

    function roomKey(){
      return normalizeRoom(elRoom.value);
    }

    function normalizeRoomDays(days){
      const set = new Set((days || []).map(d => String(d).toLowerCase()));
      const ordered = DAY_OPTIONS.filter(d => set.has(d.id)).map(d => d.id);
      return ordered.length ? ordered : DEFAULT_ROOM_DAYS.slice();
    }

    function dayLabelShort(dayId){
      return DAY_LOOKUP.get(dayId)?.short || dayId;
    }

    function dayLabelLong(dayId){
      return DAY_LOOKUP.get(dayId)?.long || dayId;
    }

    function slotKey(dayId, hour){
      return `${dayId}-${slotKeyFromHour(hour)}`;
    }

    function parseSlotKey(slotKey){
      const raw = String(slotKey || "");
      const parts = raw.split("-", 2);
      if(parts.length < 2) return { dayId: "", time: raw };
      return { dayId: parts[0], time: parts[1] };
    }

    function isAllowedSlot(slotKey){
      const { dayId, time } = parseSlotKey(slotKey);
      return roomDaysSet.has(dayId) && SLOT_TIME_SET.has(time);
    }

    function isKnownSlot(slotKey){
      const { dayId, time } = parseSlotKey(slotKey);
      return DAY_LOOKUP.has(dayId) && SLOT_TIME_SET.has(time);
    }

    function filterSlots(slots){
      if(!Array.isArray(slots)) return [];
      return slots.filter(isAllowedSlot);
    }

    function normalizeUserSelections(slots){
      if(!Array.isArray(slots)) return [];
      return slots.filter(isKnownSlot);
    }

    function slotSortValue(slotKey){
      const { dayId, time } = parseSlotKey(slotKey);
      const dayIndex = DAY_ORDER.has(dayId) ? DAY_ORDER.get(dayId) : 99;
      const hour = Number(time.slice(0,2));
      return (dayIndex * 100) + (Number.isFinite(hour) ? hour : 0);
    }

    function applyRoomDays(days){
      roomDays = normalizeRoomDays(days);
      roomDaysSet = new Set(roomDays);
      if(!roomDaysSet.has(activeDay)) activeDay = roomDays[0] || "";
      renderDayControls();
      updateHiddenDaysHint();
    }

    function updateRoomLabel(){
      if(!elSlotRoomLabel) return;
      const rk = activeRoom || roomKey();
      elSlotRoomLabel.textContent = rk || "";
    }

    function updateHiddenDaysHint(){
      if(!elHiddenDaysHint) return;
      const hidden = new Set();
      for(const s of userSelections){
        if(!isKnownSlot(s)) continue;
        const parsed = parseSlotKey(s);
        if(parsed.dayId && !roomDaysSet.has(parsed.dayId)){
          hidden.add(parsed.dayId);
        }
      }

      if(hidden.size === 0){
        elHiddenDaysHint.style.display = "none";
        elHiddenDaysHint.textContent = "";
        return;
      }

      const labels = Array.from(hidden)
        .sort((a,b) => (DAY_ORDER.get(a) ?? 99) - (DAY_ORDER.get(b) ?? 99))
        .map(dayLabelShort)
        .join(", ");
      elHiddenDaysHint.textContent = `Hidden selections on: ${labels}`;
      elHiddenDaysHint.style.display = "block";
    }

    function setRoomFromInput(){
      const normalized = roomKey();
      if(normalized !== elRoom.value) elRoom.value = normalized;
      const needsResubscribe = normalized !== activeRoom || !roomUnsub || !roomDocUnsub;
      if(!needsResubscribe) return;

      activeRoom = normalized;
      roomConfigSeeded = false;
      updateRoomLabel();

      if(roomUnsub){
        roomUnsub();
        roomUnsub = null;
      }
      if(roomDocUnsub){
        roomDocUnsub();
        roomDocUnsub = null;
      }

      roomMembers = {};
      userSelections = new Set();
      roomDays = DEFAULT_ROOM_DAYS.slice();
      roomDaysSet = new Set(roomDays);
      activeDay = roomDays[0] || "";
      roomOpen = true;
      roomStatusUpdatedAt = null;
      roomStatusByName = "";
      roomStatusByEmail = "";
      roomAdmins = [];
      isAdmin = false;
      renderAll();

      if(!activeRoom) return;
      if(!ensureDb(false) || !ensureAuth(false)) return;

      roomDocUnsub = onSnapshot(
        doc(db, "rooms", activeRoom),
        (docSnap) => {
          const data = docSnap.data() || {};
          if(Array.isArray(data.days)){
            applyRoomDays(data.days);
          }else{
            applyRoomDays(DEFAULT_ROOM_DAYS);
            if(!roomConfigSeeded){
              roomConfigSeeded = true;
              void saveRoomDays(DEFAULT_ROOM_DAYS, false);
            }
          }
          roomOpen = typeof data.isOpen === "boolean" ? data.isOpen : true;
          roomStatusUpdatedAt = data.statusUpdatedAt && typeof data.statusUpdatedAt.toDate === "function"
            ? data.statusUpdatedAt.toDate()
            : null;
          roomStatusByName = typeof data.statusByName === "string" ? data.statusByName : "";
          roomStatusByEmail = typeof data.statusByEmail === "string" ? data.statusByEmail : "";
          roomAdmins = Array.isArray(data.admins)
            ? data.admins.map(email => String(email).toLowerCase())
            : [];
          updateAdminState();
          renderAll();
        },
        (err) => {
          console.error(err);
          toast("Unable to load room settings.");
        }
      );

      roomUnsub = onSnapshot(
        collection(db, "rooms", activeRoom, "members"),
        (snapshot) => {
          const nextMembers = {};
          snapshot.forEach((docSnap) => {
            const data = docSnap.data() || {};
            const emailLower = String(data.email || docSnap.id || "").toLowerCase();
            const updatedAt = data.updatedAt && typeof data.updatedAt.toDate === "function"
              ? data.updatedAt.toDate()
              : null;

            nextMembers[emailLower] = {
              name: data.name || "",
              email: emailLower,
              tz: data.tz || "",
              slots: Array.isArray(data.slots) ? data.slots : [],
              updatedAt
            };
          });

          roomMembers = nextMembers;
          syncFromSnapshot();
          renderAll();
        },
        (err) => {
          console.error(err);
          toast("Unable to load room data.");
        }
      );
    }

    function ensureActiveRoom(){
      const rk = roomKey();
      if(!rk) return "";
      if(rk !== activeRoom) setRoomFromInput();
      return rk;
    }

    function getUserEmail(){
      if(authUser && authUser.email) return authUser.email.toLowerCase();
      return "";
    }

    function isValidEmail(email){
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email.trim());
    }

    // ---------- Time labels ----------
    function pad2(n){ return String(n).padStart(2,"0"); }
    function slotKeyFromHour(hour){ return `${pad2(hour)}:00`; }

    function etLabel(hour){
      const h12 = ((hour + 11) % 12) + 1;
      const ampm = hour >= 12 ? "PM" : "AM";
      return `${h12}:00 ${ampm}`;
    }

    function timeZoneAbbr(date, timeZone){
      try{
        const fmt = new Intl.DateTimeFormat("en-US", { timeZone, timeZoneName: "short" });
        const part = fmt.formatToParts(date).find(p => p.type === "timeZoneName");
        return part ? part.value : "";
      }catch{
        return "";
      }
    }

    function etAbbr(hourEt){
      const d = makeZonedDate(REF_DATE.year, REF_DATE.month, REF_DATE.day, hourEt, 0, ET_TIMEZONE);
      return timeZoneAbbr(d, ET_TIMEZONE) || "ET";
    }

    function etLabelWithZone(hourEt){
      return `${etLabel(hourEt)} ${etAbbr(hourEt)}`;
    }

    function makeZonedDate(year, month, day, hour, minute, timeZone, second = 0){
      const utcGuess = new Date(Date.UTC(year, month-1, day, hour, minute, second));
      const offsetMs = tzOffsetMs(utcGuess, timeZone);
      return new Date(utcGuess.getTime() - offsetMs);
    }

    function tzOffsetMs(date, timeZone){
      const f = new Intl.DateTimeFormat("en-US", {
        timeZone,
        year: "numeric", month: "2-digit", day: "2-digit",
        hour: "2-digit", minute: "2-digit", second: "2-digit",
        hour12: false
      });
      const parts = f.formatToParts(date);
      const get = (t) => Number(parts.find(p => p.type === t).value);
      const asUTC = Date.UTC(get("year"), get("month")-1, get("day"), get("hour"), get("minute"), get("second"));
      return asUTC - date.getTime();
    }

    function etToLocalLabel(hourEt){
      const d = makeZonedDate(REF_DATE.year, REF_DATE.month, REF_DATE.day, hourEt, 0, ET_TIMEZONE);
      const tz = safeTimeZone(userTz);
      const time = new Intl.DateTimeFormat(undefined, {
        hour:"numeric", minute:"2-digit", hour12:true, timeZone: tz
      }).format(d);
      const abbr = timeZoneAbbr(d, tz);
      return abbr ? `${time} ${abbr}` : time;
    }

    function isSchedulingClosed(){
      return Date.now() >= SCHEDULE_CLOSE_ET.getTime();
    }

    function isInteractionLocked(){
      return scheduleClosed || !roomOpen || !authUser;
    }

    function lockMessage(){
      if(scheduleClosed) return "Scheduling is closed.";
      if(!roomOpen) return "Room is closed.";
      if(!authUser) return "Sign in to continue.";
      return "";
    }

    function updateScheduleStatus(){
      scheduleClosed = isSchedulingClosed();
      updateActionState();
    }

    function updateActionState(){
      const disabled = isInteractionLocked();
      [elSaveBtn, elClearMeBtn].forEach((btn) => {
        btn.classList.toggle("isDisabled", disabled);
        btn.disabled = disabled;
        btn.setAttribute("aria-disabled", disabled ? "true" : "false");
      });
      updateRoomStatusUI();
      updateAdminUI();
      renderSlots();
    }

    function updateAdminState(){
      const email = getUserEmail();
      isAdmin = !!email && roomAdmins.includes(email);
    }

    function updateAdminUI(){
      if(!elResetRoomBtn || !elResetRoomNote || !elResetRoomNoteText) return;
      const canReset = !!authUser && !!activeRoom && !!db && isAdmin;
      elResetRoomBtn.disabled = !canReset;
      elResetRoomBtn.classList.toggle("isDisabled", !canReset);
      elResetRoomBtn.setAttribute("aria-disabled", canReset ? "false" : "true");

      let note = "Admin only.";
      if(!authUser) note = "Sign in to use admin tools.";
      else if(!activeRoom) note = "Enter a room code to enable.";
      else if(isAdmin) note = "Deletes all member selections.";
      elResetRoomNoteText.textContent = note;
    }

    function updateRoomStatusUI(){
      if(!elRoomStatusLabel || !elRoomStatusDot || !elRoomToggleBtn || !elRoomStatusMeta) return;
      const isOpen = roomOpen !== false;
      elRoomStatusLabel.textContent = isOpen ? "Room open" : "Room closed";
      elRoomStatusDot.style.background = isOpen ? "var(--good)" : "var(--bad)";
      elRoomToggleBtn.textContent = isOpen ? "Close room" : "Open room";

      const canToggle = !!authUser && !!activeRoom && !!db;
      elRoomToggleBtn.disabled = !canToggle;
      elRoomToggleBtn.classList.toggle("isDisabled", !canToggle);
      elRoomToggleBtn.setAttribute("aria-disabled", canToggle ? "false" : "true");

      const actor = roomStatusByName && roomStatusByEmail
        ? `${roomStatusByName} (${roomStatusByEmail})`
        : (roomStatusByName || roomStatusByEmail);
      const when = roomStatusUpdatedAt ? roomStatusUpdatedAt.toLocaleString() : "";
      if(actor || when){
        const verb = isOpen ? "Opened" : "Closed";
        const who = actor ? ` by ${actor}` : "";
        const time = when ? ` on ${when}` : "";
        elRoomStatusMeta.textContent = `${verb}${who}${time}.`;
        elRoomStatusMeta.style.display = "block";
      }else{
        elRoomStatusMeta.textContent = "";
        elRoomStatusMeta.style.display = "none";
      }
    }

    function renderDayControls(){
      if(!elRoomDays || !elDayTabs || !elDaySelect) return;
      const canEdit = !!authUser && !!activeRoom;

      elRoomDays.innerHTML = DAY_OPTIONS.map((d) => {
        const isActive = roomDaysSet.has(d.id);
        const disabledClass = canEdit ? "" : " isDisabled";
        const disabledAttr = canEdit ? "" : "disabled";
        return `
          <button type="button" class="dayChoice ${isActive ? "active" : ""}${disabledClass}" data-day="${d.id}"
            aria-pressed="${isActive}" ${disabledAttr}>
            ${d.short}
          </button>`;
      }).join("");

      elDayTabs.innerHTML = roomDays.map((dayId) => {
        const isActive = dayId === activeDay;
        return `
          <button type="button" class="dayTab ${isActive ? "active" : ""}" data-day="${dayId}"
            aria-pressed="${isActive}">
            ${dayLabelShort(dayId)}
          </button>`;
      }).join("");

      elDaySelect.innerHTML = roomDays.map((dayId) =>
        `<option value="${dayId}">${dayLabelLong(dayId)}</option>`
      ).join("");
      elDaySelect.value = activeDay || "";
      elDaySelect.disabled = roomDays.length === 0;
    }

    function setActiveDay(dayId){
      if(!roomDaysSet.has(dayId)) return;
      activeDay = dayId;
      renderDayControls();
      renderSlots();
    }

    function toggleRoomDay(dayId){
      if(!ensureAuth()) return;
      const rk = ensureActiveRoom();
      if(!rk) return toast("Enter a room code to set room days.");

      const next = new Set(roomDays);
      if(next.has(dayId)){
        if(next.size === 1) return toast("Select at least one day.");
        next.delete(dayId);
      }else{
        next.add(dayId);
      }

      const ordered = DAY_OPTIONS.filter(d => next.has(d.id)).map(d => d.id);
      applyRoomDays(ordered);
      renderAll();
      scheduleRoomDaysSave();
    }

    function scheduleRoomDaysSave(){
      clearTimeout(roomDaysSaveTimer);
      roomDaysSaveTimer = setTimeout(() => {
        void saveRoomDays(roomDays, false);
      }, 400);
    }

    async function saveRoomDays(days, showToast=true){
      const rk = ensureActiveRoom();
      if(!rk) return;
      if(!ensureDb(false) || !ensureAuth(false)) return;

      const payload = {
        days,
        updatedAt: serverTimestamp()
      };

      try{
        await setDoc(doc(db, "rooms", rk), payload, { merge: true });
        if(showToast) toast("Room days updated.");
      }catch(err){
        console.error(err);
        if(showToast) toast("Failed to update room days.");
      }
    }

    async function resetRoom(){
      if(!ensureAuth()) return;
      const rk = ensureActiveRoom();
      if(!rk) return toast("Enter a room code first.");
      if(!ensureDb()) return;
      if(!isAdmin) return toast("Admin access required.");

      const confirmed = window.confirm(`Reset all selections for "${rk}"? This deletes all member entries.`);
      if(!confirmed) return;

      try{
        const snapshot = await getDocs(collection(db, "rooms", rk, "members"));
        if(snapshot.empty){
          userSelections = new Set();
          renderSlots();
          return toast("Room already empty.");
        }

        let batch = writeBatch(db);
        let count = 0;
        for(const docSnap of snapshot.docs){
          batch.delete(docSnap.ref);
          count += 1;
          if(count % 400 === 0){
            await batch.commit();
            batch = writeBatch(db);
          }
        }
        await batch.commit();

        userSelections = new Set();
        renderSlots();
        toast("Room reset complete.");
      }catch(err){
        console.error(err);
        toast("Room reset failed.");
      }
    }

    async function toggleRoomStatus(){
      if(!ensureAuth()) return;
      const rk = ensureActiveRoom();
      if(!rk) return toast("Enter a room code to update room status.");
      if(!ensureDb()) return;

      const name = elName.value.trim() || (authUser && authUser.displayName) || "";
      const email = getUserEmail();
      const nextOpen = !roomOpen;
      const payload = {
        isOpen: nextOpen,
        statusUpdatedAt: serverTimestamp(),
        statusByName: name,
        statusByEmail: email
      };

      try{
        await setDoc(doc(db, "rooms", rk), payload, { merge: true });
        toast(nextOpen ? "Room opened." : "Room closed.");
      }catch(err){
        console.error(err);
        toast("Failed to update room status.");
      }
    }

    // ---------- Counts / common slots ----------
    function computeCounts(){
      const members = Object.values(roomMembers);
      const counts = {};
      for(const dayId of roomDays){
        SLOT_START_HOURS_ET.forEach(h => counts[slotKey(dayId, h)] = 0);
      }

      for(const m of members){
        const slots = filterSlots(m.slots);
        if(!slots.length) continue;
        for(const s of slots){
          if(counts[s] !== undefined) counts[s] += 1;
        }
      }
      return { counts, memberCount: members.length };
    }

    function commonSlots(){
      const { counts, memberCount } = computeCounts();
      if(memberCount === 0) return new Set();
      const common = new Set();
      for(const k of Object.keys(counts)){
        if(counts[k] === memberCount) common.add(k);
      }
      return common;
    }

    // ---------- Rendering ----------
    function renderSlots(){
      elSlotGrid.innerHTML = "";
      updateHiddenDaysHint();
      const { counts, memberCount } = computeCounts();
      const common = commonSlots();
      const locked = isInteractionLocked();

      if(!activeDay){
        elSlotGrid.innerHTML = `<div class="memberCard"><div class="memberName">No days selected</div><div class="memberEmail">Select at least one day for this room.</div></div>`;
        return;
      }

      for(const hourEt of SLOT_START_HOURS_ET){
        const key = slotKey(activeDay, hourEt);

        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "slot";
        if(locked){
          btn.classList.add("isDisabled");
          btn.disabled = true;
        }

        if(userSelections.has(key)) btn.classList.add("selected");
        if(common.has(key) && memberCount > 0) btn.classList.add("common");

        const local = etToLocalLabel(hourEt);
        const count = counts[key] || 0;
        const pct = memberCount ? Math.round((count / memberCount) * 100) : 0;

        btn.innerHTML = `
          <div class="top">
            <div class="labelEt">${etLabel(hourEt)}</div>
            <div class="count">
              <span>${count}/${memberCount || 0}</span>
              <span class="miniBar" aria-hidden="true"><span style="width:${pct}%"></span></span>
            </div>
          </div>
          <div class="labelLocal" style="display:${showLocal ? "block":"none"}">${local} (LT)</div>
          <div class="labelLocal" style="display:${showLocal ? "none":"block"}">${etLabelWithZone(hourEt)}</div>
        `;

        btn.addEventListener("click", () => {
          const msg = lockMessage();
          if(msg) return toast(msg);
          if(!ensureActiveRoom()) return toast("Enter a room code first.");
          toggleSlot(key);
        });

        elSlotGrid.appendChild(btn);
      }
    }

    function renderMembers(){
      const members = Object.values(roomMembers);
      elMemberCount.textContent = members.length;

      elMembers.innerHTML = "";

      if(!activeRoom){
        elMembers.innerHTML = `<div class="memberCard"><div class="memberName">Enter a room code to begin</div><div class="memberEmail">Team selections are scoped per room code.</div></div>`;
        return;
      }

      if(!authUser){
        elMembers.innerHTML = `<div class="memberCard"><div class="memberName">Sign in required</div><div class="memberEmail">Sign in to view and save room data.</div></div>`;
        return;
      }

      if(!db){
        elMembers.innerHTML = `<div class="memberCard"><div class="memberName">Firebase not configured</div><div class="memberEmail">Paste your config in index.html to load room data.</div></div>`;
        return;
      }

      if(members.length === 0){
        elMembers.innerHTML = `<div class="memberCard"><div class="memberName">No submissions yet</div><div class="memberEmail">Once someone saves their picks, they’ll appear here.</div></div>`;
        return;
      }

      members.sort((a,b) => (b.updatedAt ? b.updatedAt.getTime() : 0) - (a.updatedAt ? a.updatedAt.getTime() : 0));

      for(const m of members){
        const slots = filterSlots(m.slots);
        const chips = slots.length
          ? slots.slice().sort((a,b) => slotSortValue(a) - slotSortValue(b))
            .map(s => `<span class="chip">${slotLabelCompact(s)}</span>`).join("")
          : `<span class="chip none">No slots selected</span>`;

        const updated = m.updatedAt || null;

        const card = document.createElement("div");
        card.className = "memberCard";
        card.innerHTML = `
          <div class="memberTop">
            <div>
              <div class="memberName">${escapeHtml(m.name || "Unnamed")}</div>
              <div class="memberEmail">${escapeHtml(m.email || "")}</div>
            </div>
            <div style="text-align:right">
              <div style="color:var(--muted); font-size:11px">${escapeHtml(m.tz || "")}</div>
              <div style="color:var(--muted); font-size:11px">${escapeHtml(updated ? updated.toLocaleString() : "")}</div>
            </div>
          </div>
          <div class="chips">${chips}</div>
        `;
        elMembers.appendChild(card);
      }
    }

    function slotLabelCompact(slotKey){
      const parsed = parseSlotKey(slotKey);
      const time = parsed.time || "";
      const hour = Number(time.slice(0,2));
      if(!Number.isFinite(hour)) return slotKey;
      const h12 = ((hour + 11) % 12) + 1;
      const ampm = hour >= 12 ? "PM" : "AM";
      const dayLabel = parsed.dayId ? `${dayLabelShort(parsed.dayId)} ` : "";
      return `${dayLabel}${h12}${ampm} ${etAbbr(hour)}`;
    }

    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function renderAll(){
      updateRoomLabel();
      renderDayControls();
      updateActionState();
      renderMembers();
    }

    // ---------- Interaction ----------
    function toggleSlot(key){
      if(userSelections.has(key)) userSelections.delete(key);
      else userSelections.add(key);
      renderSlots();
      autoSaveIfIdentified();
    }

    function autoSaveIfIdentified(){
      if(scheduleClosed || !roomOpen || !db || !authUser) return;
      const rk = roomKey();
      const name = elName.value.trim();
      const email = getUserEmail();
      if(!rk || !name || !isValidEmail(email)) return;
      if(rk !== activeRoom) setRoomFromInput();
      void saveMe(false);
    }

    async function saveMe(showToast=true){
      if(scheduleClosed) return toast("Scheduling is closed.");
      if(!roomOpen) return toast("Room is closed.");
      const rk = ensureActiveRoom();
      const name = elName.value.trim();
      const email = getUserEmail();

      if(!rk) return toast("Please enter a room code.");
      if(!name) return toast("Please enter your name.");
      if(!isValidEmail(email)) return toast("Please enter a valid email.");
      if(!ensureDb()) return;
      if(!ensureAuth()) return;

      const payload = {
        name,
        email,
        tz: userTz,
        slots: normalizeUserSelections(Array.from(userSelections)),
        updatedAt: serverTimestamp()
      };

      try{
        await setDoc(doc(db, "rooms", rk, "members", email), payload, { merge: true });
        if(showToast) toast("Saved.");
      }catch(err){
        console.error(err);
        toast("Save failed.");
      }
    }

    async function clearMyPicks(){
      if(scheduleClosed) return toast("Scheduling is closed.");
      if(!roomOpen) return toast("Room is closed.");
      const rk = ensureActiveRoom();
      const name = elName.value.trim();
      const email = getUserEmail();

      if(!rk) return toast("Please enter a room code.");
      if(!name) return toast("Please enter your name.");
      if(!isValidEmail(email)) return toast("Please enter a valid email.");
      if(!ensureDb()) return;
      if(!ensureAuth()) return;

      userSelections = new Set();
      renderSlots();

      const payload = {
        name,
        email,
        tz: userTz,
        slots: [],
        updatedAt: serverTimestamp()
      };

      try{
        await setDoc(doc(db, "rooms", rk, "members", email), payload, { merge: true });
        toast("Cleared your picks.");
      }catch(err){
        console.error(err);
        toast("Clear failed.");
      }
    }

    function exportJson(){
      const rk = ensureActiveRoom();
      if(!rk) return toast("Enter a room code first.");
      if(!ensureDb()) return;
      if(!ensureAuth()) return;

      const members = {};
      for(const [email, m] of Object.entries(roomMembers)){
        members[email] = {
          name: m.name || "",
          email: m.email || email,
          tz: m.tz || "",
          slots: Array.isArray(m.slots) ? m.slots : [],
          updatedAt: m.updatedAt ? m.updatedAt.toISOString() : null
        };
      }

      const payload = {
        room: rk,
        days: roomDays,
        exportedAt: new Date().toISOString(),
        members
      };

      const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `team-schedule-${rk}-${new Date().toISOString().slice(0,10)}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      toast("Exported.");
    }

    function toggleLocal(){
      showLocal = !showLocal;
      elToggleLocal.textContent = showLocal ? "Your local time (LT)" : "US Eastern Time";
      renderSlots();
    }

    function syncFromSnapshot(){
      if(!authUser) return;
      const email = getUserEmail();
      if(!isValidEmail(email)) return;

      const me = roomMembers[email];
      if(!me) return;

      if(!elName.value.trim()) elName.value = me.name || "";
      if(me.tz) setUserTimeZone(me.tz, { save: false, showToast: false });
      userSelections = new Set(normalizeUserSelections(me.slots));
    }

    function onRoomInput(){
      clearTimeout(roomDebounce);
      updateRoomLabel();
      roomDebounce = setTimeout(setRoomFromInput, 250);
    }

    function onRoomCommit(){
      clearTimeout(roomDebounce);
      setRoomFromInput();
    }

    // ---------- Wiring ----------
    elSaveBtn.addEventListener("click", () => void saveMe(true));
    elClearMeBtn.addEventListener("click", () => void clearMyPicks());
    elExportBtn.addEventListener("click", exportJson);
    elResetRoomBtn.addEventListener("click", () => void resetRoom());
    elToggleLocal.addEventListener("click", toggleLocal);
    elThemeBtn.addEventListener("click", toggleTheme);
    elCopyRoomBtn.addEventListener("click", copyRoomCode);
    elSignInBtn.addEventListener("click", () => setAuthMode("signin"));
    elSignUpBtn.addEventListener("click", () => setAuthMode("signup"));
    elEmailLinkBtn.addEventListener("click", () => setAuthMode("emaillink"));
    elGoogleBtn.addEventListener("click", () => void signInGoogle());
    elSignOutBtn.addEventListener("click", () => void signOutUser());
    elAuthSubmitBtn.addEventListener("click", submitAuth);
    elRoomToggleBtn.addEventListener("click", () => void toggleRoomStatus());

    elRoomDays.addEventListener("click", (e) => {
      const btn = e.target.closest("button[data-day]");
      if(!btn) return;
      toggleRoomDay(btn.dataset.day);
    });

    elDayTabs.addEventListener("click", (e) => {
      const btn = e.target.closest("button[data-day]");
      if(!btn) return;
      setActiveDay(btn.dataset.day);
    });

    elDaySelect.addEventListener("change", (e) => {
      setActiveDay(e.target.value);
    });

    elRoom.addEventListener("input", onRoomInput);
    elRoom.addEventListener("blur", onRoomCommit);
    elRoom.addEventListener("keydown", (e) => { if(e.key === "Enter") { e.preventDefault(); onRoomCommit(); } });

    elName.addEventListener("input", autoSaveIfIdentified);
    elAuthPassword.addEventListener("keydown", (e) => {
      if(e.key === "Enter"){
        e.preventDefault();
        submitAuth();
      }
    });
    elAuthEmail.addEventListener("keydown", (e) => {
      if(e.key !== "Enter") return;
      e.preventDefault();
      if(authMode === "emaillink") return submitAuth();
      if(authMode === "signin" || authMode === "signup") return elAuthPassword.focus();
    });
    if(elTzInput){
      elTzInput.addEventListener("change", commitTimeZoneInput);
      elTzInput.addEventListener("keydown", (e) => {
        if(e.key !== "Enter") return;
        e.preventDefault();
        commitTimeZoneInput();
      });
    }
    if(elTzResetBtn){
      elTzResetBtn.addEventListener("click", () => {
        if(!authUser) return toast("Sign in to change time zone.");
        setUserTimeZone(deviceTz, { save: true, showToast: false });
        toast("Time zone reset to device.");
      });
    }

    // ---------- Init ----------
    (function init(){
      initTheme();
      initTimeZoneOptions();
      initFirebase();
      handleEmailLinkSignIn();
      updateScheduleStatus();
      setRoomFromInput();
      renderAll();
      setInterval(updateScheduleStatus, 60 * 1000);
    })();
  </script>
</body>
</html>
